{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrahead %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'admin/css/custom_admin_styles.css' %}">
  <script src="{% static 'admin/js/processo_judicial_enhancer.js' %}"></script>
  <style>
    .import-result-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1200;
      padding: 16px;
    }
    .import-result-modal {
      background: #fff;
      border-radius: 10px;
      width: min(560px, 100%);
      box-shadow: 0 18px 38px rgba(0, 0, 0, 0.24);
      border: 1px solid #d7dee8;
      overflow: hidden;
    }
    .import-result-modal__header {
      background: #2b6d8d;
      color: #fff;
      padding: 12px 16px;
      font-size: 18px;
      font-weight: 700;
    }
    .import-result-modal__body {
      padding: 16px;
      color: #223;
    }
    .import-result-modal__list {
      margin: 8px 0 0 0;
      padding-left: 18px;
    }
    .import-result-modal__actions {
      padding: 12px 16px 16px 16px;
      text-align: right;
    }
  </style>
{% endblock %}

{% block content %}
<div class="demandas-page">
  <div class="demandas-panel">
    {% if import_modal_data %}
      <div class="import-result-modal-overlay" id="import-result-modal-overlay" role="dialog" aria-modal="true" aria-labelledby="import-result-modal-title">
        <div class="import-result-modal">
          <div class="import-result-modal__header" id="import-result-modal-title">{{ import_modal_data.title|default:"Importação concluída" }}</div>
          <div class="import-result-modal__body">
            {% if import_modal_data.error %}
              <div>{{ import_modal_data.error }}</div>
            {% elif import_modal_data.mode == "remove" %}
              <div>Resumo da remoção:</div>
              <ul class="import-result-modal__list">
                {% if import_modal_data.carteira_nome %}
                  <li>Carteira da operação: {{ import_modal_data.carteira_nome }}</li>
                {% endif %}
                <li>CPFs selecionados: {{ import_modal_data.selected_cpfs|default:0 }}</li>
                <li>CPFs afetados: {{ import_modal_data.affected_cpfs|default:0 }}</li>
                <li>Cadastros encontrados: {{ import_modal_data.matched_processes|default:0 }}</li>
                <li>Cadastros removidos: {{ import_modal_data.deleted_processes|default:0 }}</li>
                <li>CNJs removidos: {{ import_modal_data.removed_cnjs|default:0 }}</li>
                <li>Cards removidos: {{ import_modal_data.removed_cards|default:0 }}</li>
              </ul>
              {% if import_modal_data.note %}
                <div style="margin-top:10px; opacity:.85;">{{ import_modal_data.note }}</div>
              {% endif %}
            {% else %}
              <div>Resumo do processamento:</div>
              <ul class="import-result-modal__list">
                <li>Cadastros: {{ import_modal_data.created_cadastros|default:0 }} novo(s), {{ import_modal_data.updated_cadastros|default:0 }} atualizado(s)</li>
                <li>CNJs: {{ import_modal_data.created_cnjs|default:0 }} novo(s), {{ import_modal_data.updated_cnjs|default:0 }} atualizado(s)</li>
                <li>Cards: {{ import_modal_data.created_cards|default:0 }} novo(s), {{ import_modal_data.updated_cards|default:0 }} atualizado(s)</li>
                {% if import_modal_data.reused_priority_tags or import_modal_data.standardized_priority_tags %}
                  <li>Etiquetas prioridade: {{ import_modal_data.reused_priority_tags }} reaproveitada(s), {{ import_modal_data.standardized_priority_tags }} padronizada(s)</li>
                {% endif %}
                {% if import_modal_data.applied_tasks %}
                  <li>Agenda Geral: {{ import_modal_data.applied_tasks }} tarefa(s) aplicada(s) em {{ import_modal_data.applied_tasks_targets }} processo(s)</li>
                {% endif %}
              </ul>
              {% if import_modal_data.note %}
                <div style="margin-top:10px; opacity:.85;">{{ import_modal_data.note }}</div>
              {% endif %}
            {% endif %}
          </div>
          <div class="import-result-modal__actions">
            <button type="button" class="button default" id="import-result-modal-close">OK</button>
          </div>
        </div>
      </div>
      <script>
        (function () {
          const overlay = document.getElementById('import-result-modal-overlay');
          const closeBtn = document.getElementById('import-result-modal-close');
          if (!overlay || !closeBtn) return;
          const closeModal = () => {
            overlay.style.display = 'none';
          };
          closeBtn.addEventListener('click', closeModal);
          overlay.addEventListener('click', (event) => {
            if (event.target === overlay) closeModal();
          });
          window.requestAnimationFrame(() => closeBtn.focus());
        })();
      </script>
    {% endif %}

    <div class="demandas-header">
      <div>
        <div style="opacity: .8;">
          Importa planilha Passivas (.xlsx/.csv) criando cadastros/CNJs e salvando cards no caderno.
        </div>
      </div>
      <div style="display:flex; gap:10px; align-items:center;">
        <a class="button" href="{{ back_url }}">Voltar</a>
      </div>
    </div>

	    <form method="post" enctype="multipart/form-data" style="margin-top: 16px;">
		      {% csrf_token %}
		      {{ form.upload_token }}
		      <input type="hidden" name="selected_cpfs_payload" id="id_selected_cpfs_payload" value="{{ selected_cpfs_payload|default:'' }}">
		      <input type="hidden" name="action_override" id="id_action_override" value="">
		      <input type="hidden" name="supervisor_password" id="id_supervisor_password" value="">
		      <script>
		        (function () {
		          const el = document.getElementsByName('upload_token')[0];
		          if (el && "{{ upload_token_value|escapejs }}") el.value = "{{ upload_token_value|escapejs }}";
	        })();
	      </script>

      <div class="demandas-form__row demandas-form__row--stacked">
        <div class="demandas-form__group demandas-form__group--wide">
          <label class="demandas-form__label">{{ form.arquivo.label }}</label>
          {{ form.arquivo }}
          {% if kept_upload_name %}
            <div class="help" style="margin-top: 6px;">
              Arquivo mantido para importação: <strong>{{ kept_upload_name }}</strong>
              <span style="opacity: .8;">(não precisa anexar novamente)</span>
            </div>
          {% endif %}
          {% if form.arquivo.errors %}<div class="errornote">{{ form.arquivo.errors }}</div>{% endif %}
        </div>
      </div>

      <div class="demandas-form__row">
        <div class="demandas-form__group">
          <label class="demandas-form__label">{{ form.carteira.label }}</label>
          {{ form.carteira }}
          {% if form.carteira.errors %}<div class="errornote">{{ form.carteira.errors }}</div>{% endif %}
        </div>
        <div class="demandas-form__group">
          <label class="demandas-form__label">{{ form.tipo_analise.label }}</label>
          {{ form.tipo_analise }}
          {% if form.tipo_analise.errors %}<div class="errornote">{{ form.tipo_analise.errors }}</div>{% endif %}
        </div>
      </div>

      <div class="demandas-form__row">
        <div class="demandas-form__group">
          <label class="demandas-form__label">{{ form.uf.label }}</label>
          {{ form.uf }}
          {% if form.uf.help_text %}<div class="help">{{ form.uf.help_text }}</div>{% endif %}
          {% if form.uf.errors %}<div class="errornote">{{ form.uf.errors }}</div>{% endif %}
        </div>
        <div class="demandas-form__group">
          <label class="demandas-form__label">{{ form.sheet_prefix.label }}</label>
          {{ form.sheet_prefix }}
          {% if form.sheet_prefix.help_text %}<div class="help">{{ form.sheet_prefix.help_text }}</div>{% endif %}
          {% if form.sheet_prefix.errors %}<div class="errornote">{{ form.sheet_prefix.errors }}</div>{% endif %}
        </div>
        <div class="demandas-form__group">
          <label class="demandas-form__label">{{ form.limit.label }}</label>
          {{ form.limit }}
          {% if form.limit.help_text %}<div class="help">{{ form.limit.help_text }}</div>{% endif %}
          {% if form.limit.errors %}<div class="errornote">{{ form.limit.errors }}</div>{% endif %}
        </div>
      </div>

      <div class="demandas-form__row">
        <div class="demandas-form__group demandas-form__group--wide">
          <label class="demandas-form__label" for="id_considerar_prioridade" style="display:flex; gap:8px; align-items:center;">
            <input
              type="checkbox"
              id="id_considerar_prioridade"
              name="considerar_prioridade"
              value="1"
              {% if consider_priority %}checked{% endif %}
            >
            Considerar Prioridade
          </label>
          <div
            id="prioridade-select-wrapper"
            style="{% if not consider_priority %}display:none;{% endif %} margin-top: 8px;"
          >
            <label class="demandas-form__label" for="id_selected_prioridades">Prioridades (uma ou várias)</label>
            <select
              id="id_selected_prioridades"
              name="selected_prioridades"
              multiple
              size="6"
              class="form-control"
              style="min-height: 120px;"
            >
              {% for opt in priority_options %}
                <option value="{{ opt.value }}" {% if opt.value in selected_priority_keys %}selected{% endif %}>
                  {{ opt.label }}
                </option>
              {% endfor %}
            </select>
            {% if not priority_options %}
              <div class="help">Gere a pré-visualização para carregar as prioridades da planilha.</div>
            {% else %}
              <div class="help">Quando selecionadas, a prévia/importação foca nessas prioridades.</div>
            {% endif %}
          </div>
        </div>
      </div>
      <script>
        (function () {
          const priorityToggle = document.getElementById('id_considerar_prioridade');
          const priorityWrapper = document.getElementById('prioridade-select-wrapper');
          if (!priorityToggle || !priorityWrapper) return;
          const syncPriorityVisibility = () => {
            priorityWrapper.style.display = priorityToggle.checked ? '' : 'none';
          };
          priorityToggle.addEventListener('change', syncPriorityVisibility);
          syncPriorityVisibility();
        })();

        (function () {
	          const bindImportSubmitState = () => {
	            const formEl = document.querySelector('.demandas-panel form');
	            const importBtn = document.getElementById('planilha-import-btn');
	            const removeBtn = document.getElementById('planilha-remove-btn');
	            const actionOverrideInput = document.getElementById('id_action_override');
	            const supervisorPasswordInput = document.getElementById('id_supervisor_password');
	            if (!formEl || !importBtn) return;

	            formEl.addEventListener('submit', (event) => {
	              const submitter = event.submitter || document.activeElement;
	              const submitterName = submitter ? submitter.name : '';
	              const submitterValue = submitter ? submitter.value : '';
	              const isImportAction = Boolean(
	                submitter
	                && submitterName === 'action'
	                && submitterValue === 'import'
	              );
	              const isRemoveAction = Boolean(
	                submitter
	                && submitterName === 'action'
	                && submitterValue === 'remove'
	              );
	              if (actionOverrideInput) {
	                actionOverrideInput.value = '';
	              }
	              if (!isRemoveAction && supervisorPasswordInput) {
	                supervisorPasswordInput.value = '';
	              }
	              if (!isImportAction && !isRemoveAction) return;

	              if (isImportAction && importBtn.dataset.importing === '1') {
	                event.preventDefault();
	                return;
	              }

	              if (isRemoveAction) {
	                if (formEl.dataset.removeSubmitting === '1') {
	                  event.preventDefault();
	                  return;
	                }

	                if (formEl.dataset.removeConfirmed !== '1') {
	                  const password = window.prompt('Informe sua senha de Supervisor para confirmar a remoção:');
	                  if (!password) {
	                    event.preventDefault();
	                    return;
	                  }
	                  if (supervisorPasswordInput) {
	                    supervisorPasswordInput.value = password;
	                  }
	                  formEl.dataset.removeConfirmed = '1';
	                }
	                if (actionOverrideInput) {
	                  actionOverrideInput.value = 'remove';
	                }
	                formEl.dataset.removeSubmitting = '1';
	                if (removeBtn) {
	                  removeBtn.dataset.removing = '1';
	                  removeBtn.style.pointerEvents = 'none';
	                  removeBtn.setAttribute('aria-disabled', 'true');
	                  removeBtn.classList.add('disabled');
	                  removeBtn.textContent = 'Removendo...';
	                }
	                return;
	              }

	              if (actionOverrideInput) {
	                actionOverrideInput.value = 'import';
	              }
	              importBtn.dataset.importing = '1';
	              importBtn.style.pointerEvents = 'none';
	              importBtn.setAttribute('aria-disabled', 'true');
	              importBtn.classList.add('disabled');
	              importBtn.textContent = 'Importando...';
            });
          };

          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', bindImportSubmitState);
            return;
          }
          bindImportSubmitState();
        })();
      </script>

	      <div class="demandas-form__footer">
		        <div class="demandas-form__actions">
		          <button class="button" type="submit" name="action" value="preview">Pré-visualizar</button>
		          <button class="button default" type="submit" name="action" value="import" id="planilha-import-btn">Importar</button>
		          <button class="button" type="submit" name="action" value="cancel" formnovalidate>Cancelar importação</button>
		        </div>
	      </div>

	    {% if preview %}
	      <hr style="margin: 18px 0;">
	      <h2>Prévia</h2>
	      <ul style="margin-top: 6px;">
	        <li><strong>Linhas:</strong> {{ preview.rows }}</li>
	        <li><strong>Analisados:</strong> {{ preview.analysed_cpfs }} CPF(s)</li>
	        <li><strong>Já importados:</strong> {{ preview.imported_cpfs }} CPF(s)</li>
	        <li><strong>CPFs:</strong> {{ preview.cpfs }}</li>
	        <li><strong>CNJs:</strong> {{ preview.cnjs }}</li>
	        <li><strong>UFs:</strong> {{ preview.ufs }}</li>
	        {% if preview.priority_options_count %}
	          <li><strong>Prioridades na prévia:</strong> {{ preview.priority_options_count }}</li>
	        {% endif %}
	      </ul>
	
	      {% if preview.cpf_rows %}
	        <h3 style="margin-top: 14px;">Selecionar CPFs para importar</h3>
	        <div style="display:flex; gap:10px; margin: 8px 0 10px 0; flex-wrap:wrap;">
		          <button type="button" class="button" id="filter-only-other-carteira">Mostrar só já em outras carteiras</button>
		          <button type="button" class="button" id="filter-show-all">Mostrar todos</button>
		          <button type="button" class="button" id="sel-all">Selecionar todos</button>
		          <button type="button" class="button" id="sel-not-imported">Selecionar não importados</button>
		          <button type="button" class="button" id="sel-none">Limpar seleção</button>
		          <button type="button" class="button" id="sel-analysed">Selecionar “já analisados”</button>
		          <button type="submit" class="button" name="action" value="remove" id="planilha-remove-btn">Remover selecionados</button>
		          <span id="preview-filter-info" style="opacity:.75; align-self:center;"></span>
		          <span style="opacity:.75; align-self:center;">(arquivo permanece salvo após importar; use “Cancelar importação” para descartar)</span>
		        </div>
	        <table class="adminlist" style="width: 100%; border-collapse: collapse;">
	          <thead>
	            <tr>
	              <th style="text-align:left; width: 44px;"></th>
	              <th style="text-align:left;">UF</th>
	              <th style="text-align:left;">Prioridade</th>
	              <th style="text-align:left;">CPF</th>
	              <th style="text-align:left;">Parte contrária</th>
	              <th style="text-align:left;">CNJs</th>
	              <th style="text-align:left;">Status</th>
	            </tr>
	          </thead>
	          <tbody>
	            {% for row in preview.cpf_rows %}
	              <tr data-exists-other-carteira="{{ row.exists_only_other_carteira|yesno:'1,0' }}">
	                <td>
	                  <input
	                    type="checkbox"
	                    class="js-planilha-cpf-box"
	                    data-cpf="{{ row.cpf }}"
	                    data-prechecked="{{ row.prechecked|yesno:'1,0' }}"
	                    data-imported-full="{{ row.imported_full|yesno:'1,0' }}"
	                    data-exists-other-carteira="{{ row.exists_only_other_carteira|yesno:'1,0' }}"
	                    {% if row.checked %}checked{% endif %}
	                  >
	                </td>
	                <td>{{ row.uf }}</td>
	                <td>{{ row.prioridade }}</td>
	                <td>{{ row.cpf }}</td>
	                <td>{{ row.parte_contraria }}</td>
	                <td>{{ row.cnj_count }}</td>
	                <td>
	                  {% if row.imported_full %}
	                    <span class="mini-postit">Já importado ({{ row.imported_count }}/{{ row.imported_total }})</span>
	                  {% elif row.imported_partial %}
	                    <span class="mini-postit">Importação parcial ({{ row.imported_count }}/{{ row.imported_total }})</span>
	                  {% else %}
	                    <span style="opacity:.75;">Não importado</span>
	                  {% endif %}
	                  <br>
	                  {% if row.prechecked %}
	                    <span style="opacity:.75;">Já analisado</span>
	                  {% else %}
	                    <span style="opacity:.65;">Sem respostas</span>
	                  {% endif %}
	                  {% if row.has_process %}
	                    <br>
	                    {% if row.exists_only_other_carteira %}
	                      <span style="opacity:.8;">Já existe em outra carteira: {{ row.other_carteiras_display }}</span>
	                    {% else %}
	                      <span style="opacity:.8;">Carteira(s): {{ row.existing_carteiras_display }}</span>
	                    {% endif %}
	                  {% endif %}
	                </td>
	              </tr>
	            {% endfor %}
	          </tbody>
	        </table>
	        <script>
	          (function () {
	            const formEl = document.querySelector('.demandas-panel form');
	            const payloadEl = document.getElementById('id_selected_cpfs_payload');
	            const tableRows = () => Array.from(document.querySelectorAll('tr[data-exists-other-carteira]'));
	            const visibleRows = () => tableRows().filter((row) => row.style.display !== 'none');
	            const boxes = () => Array.from(document.querySelectorAll('.js-planilha-cpf-box'));
	            const visibleBoxes = () => visibleRows()
	              .map((row) => row.querySelector('.js-planilha-cpf-box'))
	              .filter(Boolean);
	            const filterInfo = document.getElementById('preview-filter-info');
	            const syncSelectedCpfsPayload = () => {
	              if (!payloadEl) return;
	              const cpfs = boxes()
	                .filter((b) => b.checked)
	                .map((b) => (b.dataset.cpf || '').trim())
	                .filter(Boolean);
	              payloadEl.value = Array.from(new Set(cpfs)).join(',');
	            };
	            const updateFilterInfo = () => {
	              if (!filterInfo) return;
	              const total = tableRows().length;
	              const visible = visibleRows().length;
	              filterInfo.textContent = `Mostrando ${visible} de ${total} CPF(s) na prévia`;
	            };
	            const applyOnlyOtherCarteiraFilter = (onlyOther) => {
	              tableRows().forEach((row) => {
	                const isOther = row.dataset.existsOtherCarteira === '1';
	                row.style.display = (!onlyOther || isOther) ? '' : 'none';
	              });
	              updateFilterInfo();
	            };
	            const setAll = (checked) => {
	              visibleBoxes().forEach((b) => {
	                b.checked = checked;
	              });
	              syncSelectedCpfsPayload();
	            };
	            const setAnalysed = () => {
	              visibleBoxes().forEach((b) => {
	                b.checked = (b.dataset.prechecked === '1');
	              });
	              syncSelectedCpfsPayload();
	            };
	            const setNotImported = () => {
	              visibleBoxes().forEach((b) => {
	                b.checked = (b.dataset.importedFull !== '1');
	              });
	              syncSelectedCpfsPayload();
	            };
	            const allBtn = document.getElementById('sel-all');
	            const notImportedBtn = document.getElementById('sel-not-imported');
	            const noneBtn = document.getElementById('sel-none');
	            const analysedBtn = document.getElementById('sel-analysed');
	            const filterOnlyOtherBtn = document.getElementById('filter-only-other-carteira');
	            const filterShowAllBtn = document.getElementById('filter-show-all');
	            boxes().forEach((b) => b.addEventListener('change', syncSelectedCpfsPayload));
	            if (formEl) formEl.addEventListener('submit', syncSelectedCpfsPayload);
	            if (allBtn) allBtn.addEventListener('click', () => setAll(true));
	            if (notImportedBtn) notImportedBtn.addEventListener('click', () => setNotImported());
	            if (noneBtn) noneBtn.addEventListener('click', () => setAll(false));
	            if (analysedBtn) analysedBtn.addEventListener('click', () => setAnalysed());
	            if (filterOnlyOtherBtn) {
	              filterOnlyOtherBtn.addEventListener('click', () => applyOnlyOtherCarteiraFilter(true));
	            }
	            if (filterShowAllBtn) {
	              filterShowAllBtn.addEventListener('click', () => applyOnlyOtherCarteiraFilter(false));
	            }
	            applyOnlyOtherCarteiraFilter(false);
	            syncSelectedCpfsPayload();
	          })();
	        </script>
	      {% endif %}
	    {% endif %}
	    </form>
	  </div>
	</div>
	{% endblock %}
