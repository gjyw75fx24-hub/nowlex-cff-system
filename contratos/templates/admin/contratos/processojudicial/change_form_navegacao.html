{% extends "admin/contratos/processojudicial/change_form_etiquetas.html" %}
{% load i18n %}

{% block extrahead %}
{{ block.super }}
<script>
window.__analise_is_supervisor = {{ is_supervisor|default_if_none:False|yesno:"true,false" }};
window.__tipos_peticao_api_url = "{{ tipos_peticao_api_url|default:'' }}";
</script>
{% endblock %}

{% block content %}
<div class="navigation-buttons" style="text-align: right; margin-bottom: 10px;">
  {% if prev_obj_url %}
    <a href="{{ prev_obj_url }}" class="button" style="font-size: 1.2em; padding: 5px 10px; margin-right: 5px; background: none; border: none; box-shadow: none; color: #417690;"><</a>
  {% else %}
    <span class="button disabled" style="font-size: 1.2em; padding: 5px 10px; margin-right: 5px; background: none; border: none; box-shadow: none; color: #ccc; cursor: default;"> < </span>
  {% endif %}
  
  {% if next_obj_url %}
    <a href="{{ next_obj_url }}" class="button" style="font-size: 1.2em; padding: 5px 10px; background: none; border: none; box-shadow: none; color: #417690;"> > </a>
  {% else %}
    <span class="button disabled" style="font-size: 1.2em; padding: 5px 10px; background: none; border: none; box-shadow: none; color: #ccc; cursor: default;"> > </span>
  {% endif %}
</div>
{{ block.super }} {# Render the content from the parent template #}

<div id="file-preview-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:10000; align-items:center; justify-content:center;">
  <div id="file-preview-content" style="background:#fff; padding:12px; border-radius:6px; max-width:90%; max-height:90%; position:relative; box-shadow:0 8px 24px rgba(0,0,0,0.25);"></div>
  <button id="file-preview-close" style="position:absolute; top:12px; right:16px; background:#444; color:#fff; border:none; padding:6px 10px; border-radius:4px; cursor:pointer;">Fechar</button>
</div>

<style>
#processoarquivo_set-group th.delete,
#processoarquivo_set-group td.delete,
#processoarquivo_set-group th.column-delete,
#processoarquivo_set-group td.column-delete,
#processoarquivo_set-group thead th:last-child,
#processoarquivo_set-group tbody td:last-child {
  display: none !important;
}

.monitoria-checkbox-wrapper {
  display: inline-flex;
  align-items: center;
  margin-left: 8px;
}

.monitoria-checkbox-wrapper input[type="checkbox"] {
  display: none;
}

.monitoria-checkbox-wrapper span {
  font-size: 0.85rem;
  letter-spacing: 0.08em;
  padding: 6px 12px;
  border-radius: 6px;
  border: 1px solid #32435b;
  background: #ffffff;
  color: #2a4a6c;
  font-weight: 600;
  cursor: pointer;
  box-shadow: inset 0 -2px 0 rgba(0, 0, 0, 0.2);
  transition: background 0.15s ease, color 0.15s ease;
}

.monitoria-checkbox-wrapper input[type="checkbox"]:checked + span {
  background: #324a6c;
  color: #fff;
  box-shadow: none;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('file-preview-modal');
  const content = document.getElementById('file-preview-content');
  const closeBtn = document.getElementById('file-preview-close');
  let currentObjectUrl = null;
  if (!modal || !content || !closeBtn) return;

  // Botões "Baixar Doc Editável" e "Baixar PDF" na aba Arquivos + transformar links em "Visualizar"
  // Converte links de arquivo em botão "Visualizar" (apenas no campo de arquivo)
  (function applyVisualizarButtons() {
    const apply = () => {
      const fileLinks = document.querySelectorAll('#arquivos-group td.field-arquivo a[href], #processoarquivo_set-group td.field-arquivo a[href]');
      fileLinks.forEach(link => {
        if (link.dataset.visualizarApplied === '1') return;
        // não mexe no botão de adicionar novo arquivo
        if (link.closest('.add-row')) return;
        link.textContent = 'Visualizar';
        link.classList.add('button');
        link.style.backgroundColor = '#555';
        link.style.color = '#fff';
        link.style.padding = '3px 7px';
        link.style.fontSize = '0.85em';
        link.style.display = 'inline-block';
        link.style.marginTop = '4px';
        link.dataset.visualizarApplied = '1';
      });

      // Remove o prefixo "Atualmente:" / "Currently:" do widget de upload
      document.querySelectorAll('#arquivos-group p.file-upload, #processoarquivo_set-group p.file-upload').forEach(p => {
        const txtNode = Array.from(p.childNodes).find(n => n.nodeType === Node.TEXT_NODE && n.textContent.trim().match(/Atualmente:|Currently:/i));
        if (txtNode) {
          txtNode.textContent = '';
        }
      });
    };
    apply();
    const observer = new MutationObserver(apply);
    observer.observe(document.body, { childList: true, subtree: true });
  })();

  (function addMonitoriaCheckboxes() {
    const normalizeText = (text) => {
      if (!text) {
        return '';
      }
      return text.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    };

    const matchesMonitoria = (text) => /monitoria/i.test(normalizeText(text));

    const ensureWrapper = (row) => {
      if (!row) return;
      const nomeCell = row.querySelector('td.field-nome') || row.querySelector('td.original');
      if (!nomeCell || nomeCell.querySelector('.monitoria-checkbox-wrapper')) return;
      const nameInput = nomeCell.querySelector('input[name$="-nome"]');
      const value = (nameInput && nameInput.value) ? nameInput.value : nomeCell.textContent;
      if (!matchesMonitoria(value)) return;
      const wrapper = document.createElement('label');
      wrapper.className = 'monitoria-checkbox-wrapper';
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      const label = document.createElement('span');
      label.textContent = 'Base';
      wrapper.appendChild(checkbox);
      wrapper.appendChild(label);
      const nomeButtonsContainer = nomeCell.querySelector('div[style*="display:flex"], div[style*="display: flex"]');
      if (nomeButtonsContainer) {
        nomeButtonsContainer.appendChild(wrapper);
        return;
      }
      if (nameInput && nameInput.parentNode) {
        nameInput.parentNode.insertBefore(wrapper, nameInput);
      } else {
        const targetNode = nomeCell.querySelector('p') || nomeCell;
        targetNode.insertAdjacentElement('beforebegin', wrapper);
      }
    };

    const sync = () => {
      const inlineRows = document.querySelectorAll('#processoarquivo_set-group tr.dynamic-processoarquivo');
      const arquivoRows = document.querySelectorAll('#arquivos-group tr.dynamic-arquivos');
      inlineRows.forEach(ensureWrapper);
      arquivoRows.forEach(ensureWrapper);
    };

    const observer = new MutationObserver(sync);
    const target = document.querySelector('#processoarquivo_set-group') || document.body;
    observer.observe(target, { childList: true, subtree: true });
    sync();
    setTimeout(sync, 200);
  })();

  function closeModal() {
    modal.style.display = 'none';
    content.innerHTML = '';
    if (currentObjectUrl) {
      URL.revokeObjectURL(currentObjectUrl);
      currentObjectUrl = null;
    }
  }

  closeBtn.addEventListener('click', closeModal);
  modal.addEventListener('click', function(e) {
    if (e.target === modal) closeModal();
  });

  function renderFile(href) {
    if (!href) return;
    const isImage = /\.(png|jpe?g|gif|webp|bmp)$/i.test(href);
    const isPdf = /\.pdf$/i.test(href);
    if (!isImage && !isPdf) return;

    if (currentObjectUrl) {
      URL.revokeObjectURL(currentObjectUrl);
      currentObjectUrl = null;
    }

    if (isImage) {
      content.innerHTML = `<img src="${href}" alt="Pré-visualização" style="max-width:100%; max-height:80vh; display:block; margin:0 auto;">`;
      modal.style.display = 'flex';
      return;
    }

    content.innerHTML = `<p style="color:#555; text-align:center;">Carregando PDF...</p>`;
    fetch(href).then(res => {
      if (!res.ok) throw new Error('Falha ao carregar PDF');
      return res.blob();
    }).then(blob => {
      currentObjectUrl = URL.createObjectURL(blob);
      content.innerHTML = `
        <div style="display:flex; flex-direction:column; gap:12px; align-items:center; justify-content:center;">
          <iframe src="${currentObjectUrl}" title="Pré-visualização PDF" style="width:80vw; height:80vh; border:none;" loading="lazy"></iframe>
        </div>`;
    }).catch(() => {
      content.innerHTML = `
        <div style="display:flex; flex-direction:column; gap:12px; align-items:center; justify-content:center;">
          <p style="color:#c00;">Não foi possível pré-visualizar o PDF.</p>
        </div>`;
    });
    modal.style.display = 'flex';
  }

  document.body.addEventListener('click', function(e) {
    const link = e.target.closest('a');
    if (!link) return;
    const href = link.getAttribute('href') || '';
    // Apenas links de arquivo da pasta do processo
    if (!/\/media\/processos\//.test(href) && !/processos\/[\d]+\/pasta\//.test(href)) return;
    // Extensões suportadas (imagens, PDFs; DOCX tenta abrir o PDF-irmão, senão alerta)
    const isImage = /\.(png|jpe?g|gif|webp|bmp)$/i.test(href);
    const isPdf = /\.pdf$/i.test(href);
    const isDocx = /\.docx$/i.test(href);
    if (!isImage && !isPdf && !isDocx) return;
    e.preventDefault();

    if (isDocx) {
      const pdfHref = href.replace(/\.docx$/i, '.pdf');
      fetch(pdfHref, { method: 'HEAD' })
        .then(res => {
          if (res.ok) {
            renderFile(pdfHref);
          } else {
            alert('Pré-visualização disponível apenas em PDF. Gere/aguarde o PDF na aba Arquivos.');
          }
        })
        .catch(() => {
          alert('Pré-visualização disponível apenas em PDF. Gere/aguarde o PDF na aba Arquivos.');
        });
      return;
    }

    renderFile(href);
  }, true);

  // Insere botões de Baixar DOC e Baixar PDF dentro do inline de Arquivos
  (function injectDownloadButtons() {
    const tryInsert = () => {
      const arquivosGroup = document.querySelector('#arquivos-group') || document.querySelector('#processoarquivo_set-group');
      if (!arquivosGroup) return;

      // só insere uma vez por inline de monitoria; usa a primeira linha que tenha arquivo pdf/docx de monitoria
      if (arquivosGroup.querySelector('#id_baixar_doc_monitoria_btn') || arquivosGroup.querySelector('#id_baixar_pdf_monitoria_btn')) return;

      const targetLink = arquivosGroup.querySelector('td.field-arquivo a[href*="Monitoria"], td.field-arquivo a[href*="monitoria"], td.field-arquivo a[href$=".pdf"], td.field-arquivo a[href$=".docx"]');
      if (!targetLink) return;

      const row = targetLink.closest('tr.dynamic-processoarquivo') || targetLink.closest('tr');
      const nomeCell = row ? row.querySelector('td.field-nome') : null;
      const arquivoCell = targetLink.closest('td.field-arquivo');
      if (!row || !nomeCell || !arquivoCell) return;

      // esconde o link original (evita duplicar)
      targetLink.style.display = 'none';

      const btnRow = document.createElement('div');
      btnRow.style.display = 'flex';
      btnRow.style.flexWrap = 'wrap';
      btnRow.style.gap = '6px';
      btnRow.style.margin = '6px 0 4px 0';
      btnRow.style.alignItems = 'center';
      btnRow.style.justifyContent = 'flex-start';

      const makeBtn = (text, id) => {
        const b = document.createElement('button');
        b.type = 'button';
        b.textContent = text;
        if (id) b.id = id;
        b.className = 'button';
        b.style.padding = '4px 7px';
        b.style.background = '#555';
        b.style.color = '#fff';
        b.style.border = '1px solid #444';
        b.style.boxShadow = 'none';
        b.style.fontWeight = '400';
        b.style.fontSize = '0.85em';
        return b;
      };

      const btnVisual = document.createElement('a');
      btnVisual.href = targetLink.href;
      btnVisual.textContent = 'VISUALIZAR';
      btnVisual.className = 'button';
      btnVisual.style.padding = '4px 7px';
      btnVisual.style.background = '#555';
      btnVisual.style.color = '#fff';
      btnVisual.style.border = '1px solid #444';
      btnVisual.style.boxShadow = 'none';
      btnVisual.style.fontWeight = '400';
      btnVisual.style.fontSize = '0.85em';
      btnVisual.addEventListener('click', function(ev) {
        ev.preventDefault();
        targetLink.click();
      });

      const btnPdf = makeBtn('PDF', 'id_baixar_pdf_monitoria_btn');
      const btnDoc = makeBtn('DOC', 'id_baixar_doc_monitoria_btn');

      btnRow.appendChild(btnVisual);
      btnRow.appendChild(btnPdf);
      btnRow.appendChild(btnDoc);

      // insere abaixo do campo de nome, alinhado à direita
      const nomeInput = nomeCell.querySelector('input, textarea');
      if (nomeInput && nomeInput.parentNode) {
        nomeInput.parentNode.appendChild(btnRow);
      } else {
        nomeCell.appendChild(btnRow);
      }
    };

    tryInsert();
    const observer = new MutationObserver(tryInsert);
    observer.observe(document.body, { childList: true, subtree: true });
  })();

  // Troca o checkbox de remover por botão com confirmação no inline de Arquivos
  (function enhanceArquivoInlineDeletes() {
    const inlineGroup = document.querySelector('#processoarquivo_set-group');
    if (!inlineGroup) return;
    // esconde coluna Remover? (admin default)
    const headers = inlineGroup.querySelectorAll('th.delete, th.column-delete, thead th:last-child');
    headers.forEach(h => { h.style.display = 'none'; });
    // esconde células de delete via CSS direto
    inlineGroup.querySelectorAll('td.delete, td.column-delete').forEach(td => td.style.display = 'none');
    // fallback: esconde última coluna do thead/tbody
    const headCells = inlineGroup.querySelectorAll('table thead tr th');
    const lastIdx = headCells.length ? headCells.length - 1 : -1;
    if (lastIdx >= 0) {
      headCells[lastIdx].style.display = 'none';
      inlineGroup.querySelectorAll('table tbody tr').forEach(tr => {
        const cells = tr.querySelectorAll('td, th');
        if (cells[lastIdx]) cells[lastIdx].style.display = 'none';
      });
    }

    // Cria contêiner de remoção abaixo do bloco de andamentos
    const deleteBlockParent = Array.from(document.querySelectorAll('.submit-row')).find(el => el.textContent.includes('Excluir Andamentos Selecionados')) || document.querySelector('#content-main') || document.body;
    let removeContainer = document.getElementById('arquivo-delete-actions');
    if (!removeContainer) {
      removeContainer = document.createElement('div');
      removeContainer.id = 'arquivo-delete-actions';
      removeContainer.style.marginTop = '10px';
      removeContainer.style.display = 'flex';
      removeContainer.style.flexDirection = 'column';
      removeContainer.style.gap = '6px';
      removeContainer.innerHTML = '<strong>Remover arquivos:</strong>';
      deleteBlockParent.appendChild(removeContainer);
    }

    const rows = inlineGroup.querySelectorAll('.dynamic-processoarquivo');
    rows.forEach(row => {
      const deleteCheckbox = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
      if (!deleteCheckbox) return;
      if (row.dataset.deleteBtnAdded) return;
      const td = deleteCheckbox.closest('td, th, label');
      if (td) td.style.display = 'none';
      deleteCheckbox.style.display = 'none';

      // pega nome do arquivo
      const nomeInput = row.querySelector('input[name$="-nome"]');
      const fileName = (nomeInput && nomeInput.value) ? nomeInput.value : 'Arquivo';

      const btn = document.createElement('button');
      btn.type = 'button';
      btn.textContent = `Remover "${fileName}"`;
      btn.className = 'button';
      btn.style.backgroundColor = '#ba2121';
      btn.style.color = '#fff';
      btn.style.alignSelf = 'flex-start';
      btn.addEventListener('click', () => {
        const ok = confirm(`Remover o arquivo "${fileName}"?`);
        if (!ok) return;
        deleteCheckbox.checked = true;
        row.style.opacity = '0.5';
        row.style.pointerEvents = 'none';
      });
      removeContainer.appendChild(btn);
      row.dataset.deleteBtnAdded = '1';
    });
    // última garantia: remove checkboxes remanescentes
    inlineGroup.querySelectorAll('input[type="checkbox"][name$="-DELETE"]').forEach(cb => {
      cb.style.display = 'none';
      const wrap = cb.closest('td, th, label');
      if (wrap) wrap.style.display = 'none';
    });
  })();

  (function addMonitoriaCheckboxes() {
    const matchesMonitoria = (text) => /monit[ií]ria/i.test(text);

    const insertCheckbox = (row) => {
      if (!row || row.dataset.monitoriaCheckboxAdded) return;
      const nomeCell = row.querySelector('td.field-nome');
      if (!nomeCell) return;
      const nameInput = nomeCell.querySelector('input[name$="-nome"]');
      const labelText = nameInput ? nameInput.value : nomeCell.textContent;
      if (!labelText || !matchesMonitoria(labelText)) {
        return;
      }
      const wrapper = document.createElement('label');
      wrapper.className = 'monitoria-checkbox-wrapper';
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.dataset.monitoriaFile = '1';
      wrapper.appendChild(checkbox);
      const text = document.createElement('span');
      text.textContent = 'Base';
      wrapper.appendChild(text);
      if (nameInput) {
        nameInput.parentNode.insertBefore(wrapper, nameInput);
      } else {
        nomeCell.insertBefore(wrapper, nomeCell.firstChild);
      }
      row.dataset.monitoriaCheckboxAdded = '1';
    };

    const sync = () => {
      const rows = document.querySelectorAll('#processoarquivo_set-group tr.dynamic-processoarquivo');
      rows.forEach(insertCheckbox);
    };

    sync();
    const observer = new MutationObserver(sync);
    observer.observe(document.querySelector('#processoarquivo_set-group') || document.body, { childList: true, subtree: true });
  })();
});
</script>
{% endblock %}
