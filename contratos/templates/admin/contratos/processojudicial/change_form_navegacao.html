{% extends "admin/contratos/processojudicial/change_form_etiquetas.html" %}
{% load i18n static %}

{% block extrahead %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'admin/css/documento_modelo_peticoes.css' %}">
<!-- PDF.js para renderização de PDFs em canvas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
// Configuração do PDF.js
if (typeof pdfjsLib !== 'undefined') {
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
}
window.__analise_is_supervisor = {{ is_supervisor|default_if_none:False|yesno:"true,false" }};
window.__tipos_peticao_api_url = "{{ tipos_peticao_api_url|default:'' }}";
window.__tipos_peticao_preview_url = "{{ tipos_peticao_preview_url|default:'' }}";
window.__tipos_peticao_generate_url = "{{ tipos_peticao_generate_url|default:'' }}";
window.__tipos_peticao_csrf_token = "{{ csrf_token|default:'' }}";
</script>
{% endblock %}

{% block content %}
<div class="navigation-buttons" style="text-align: right; margin-bottom: 10px;">
  {% if prev_obj_url %}
    <a href="{{ prev_obj_url }}" class="button" style="font-size: 1.2em; padding: 5px 10px; margin-right: 5px; background: none; border: none; box-shadow: none; color: #417690;"><</a>
  {% else %}
    <span class="button disabled" style="font-size: 1.2em; padding: 5px 10px; margin-right: 5px; background: none; border: none; box-shadow: none; color: #ccc; cursor: default;"> < </span>
  {% endif %}
  
  {% if next_obj_url %}
    <a href="{{ next_obj_url }}" class="button" style="font-size: 1.2em; padding: 5px 10px; background: none; border: none; box-shadow: none; color: #417690;"> > </a>
  {% else %}
    <span class="button disabled" style="font-size: 1.2em; padding: 5px 10px; background: none; border: none; box-shadow: none; color: #ccc; cursor: default;"> > </span>
  {% endif %}
</div>
{{ block.super }} {# Render the content from the parent template #}

<div id="file-preview-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:10000; align-items:center; justify-content:center;">
  <div id="file-preview-content" style="background:#fff; padding:12px; border-radius:6px; max-width:90%; max-height:90%; position:relative; box-shadow:0 8px 24px rgba(0,0,0,0.25);"></div>
  <button id="file-preview-close" style="position:absolute; top:12px; right:16px; background:#444; color:#fff; border:none; padding:6px 10px; border-radius:4px; cursor:pointer;">Fechar</button>
</div>

<style>
  #processoarquivo_set-group th.delete,
  #processoarquivo_set-group td.delete,
  #processoarquivo_set-group th.column-delete,
  #processoarquivo_set-group td.column-delete,
  #processoarquivo_set-group th.column-arquivo,
  #arquivos-group th.delete,
  #arquivos-group td.delete,
  #arquivos-group th.column-delete,
  #arquivos-group td.column-delete,
  #arquivos-group th.column-arquivo,
  #arquivos-group td.field-arquivo,
  #arquivos-group table thead th:nth-child(3),
  #arquivos-group table tbody td:nth-child(3),
  #arquivos-group table thead th:nth-child(4),
  #arquivos-group table tbody td:nth-child(4) {
    display: none !important;
  }
  #arquivos-group table tbody tr.add-row td.field-arquivo,
  #processoarquivo_set-group table tbody tr.add-row td.field-arquivo {
    display: table-cell !important;
  }

.monitoria-checkbox-wrapper {
  display: inline-flex;
  align-items: center;
  margin-left: 10px;
}

.monitoria-checkbox-wrapper input[type="checkbox"] {
  display: none;
}

.monitoria-checkbox-wrapper span {
  font-size: 0.85rem;
  letter-spacing: 0.04em;
  padding: 6px 18px;
  border-radius: 10px;
  border: 1px solid #cbd5e0;
  background: #ffffff;
  color: #42748fff;
  font-weight: 600;
  cursor: pointer;
  box-shadow: inset 0 -1px 0 rgba(0, 0, 0, 0.08);
  transition: background 0.2s ease, color 0.2s ease, border 0.2s ease, transform 0.15s ease;
}

.monitoria-checkbox-wrapper span:focus-visible {
  outline: 2px solid rgba(66, 116, 143, 0.6);
  outline-offset: 2px;
}

.monitoria-checkbox-wrapper input[type="checkbox"]:checked + span,
.monitoria-checkbox-wrapper.checked span {
  border-color: #42748fff;
  background: #42748fff;
  color: #ffffff;
  box-shadow: 0 6px 12px rgba(66, 116, 143, 0.2);
  transform: translateY(-1px);
}
.documento-peticoes-remove-wrapper {
  display: flex;
  justify-content: flex-end;
  margin-top: 6px;
}

.documento-peticoes-modify-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 6px;
}

.documento-peticoes-modify-row .button {
  padding: 3px 10px;
  font-size: 0.85em;
}
 .documento-peticoes-modify-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 6px;
}

.documento-peticoes-modify-row .button {
  padding: 3px 10px;
  font-size: 0.85em;
}

.documento-peticoes-uploader-line {
  font-size: 0.8rem;
  color: #5f6b7a;
  margin-top: 4px;
  text-transform: capitalize;
}

#arquivos-group th.column-enviado_por,
#processoarquivo_set-group th.column-enviado_por,
#arquivos-group td.field-enviado_por,
#processoarquivo_set-group td.field-enviado_por,
#arquivos-group th.column-criado_em,
#processoarquivo_set-group th.column-criado_em,
#arquivos-group td.field-criado_em,
#processoarquivo_set-group td.field-criado_em,
#arquivos-group th.column-protocolado_no_tribunal,
#processoarquivo_set-group th.column-protocolado_no_tribunal,
#arquivos-group td.field-protocolado_no_tribunal,
#processoarquivo_set-group td.field-protocolado_no_tribunal {
  display: none;
}

  .petitions-wrap {
    position: relative;
    display: inline-flex;
    align-items: center;
    margin-left: auto;
  }

  .petitions-trigger {
    border: 1px solid rgba(11, 126, 214, 0.3);
    background: #0b7ed6;
    color: #fff;
    padding: 10px 14px;
    border-radius: 12px;
    cursor: pointer;
    font: 600 13px/1 system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;
    letter-spacing: 0.02em;
  }

  .petitions-panel {
    position: absolute;
    right: 0;
    top: calc(100% + 10px);
    opacity: 0;
    transform: translateY(-6px);
    pointer-events: none;
    transition: opacity 0.18s ease, transform 0.18s ease;
    z-index: 1000;
  }

  .petitions-panel.open {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }

  .petitions-rail {
    position: relative;
    display: flex;
    gap: 12px;
    padding: 12px;
    border-radius: 16px;
    background: #0b7ed6;
    border: 1px solid rgba(11, 126, 214, 0.6);
    box-shadow: 0 16px 40px rgba(11, 126, 214, 0.3);
  }

  .petitions-indicator {
    position: absolute;
    top: 8px;
    bottom: 8px;
    left: 12px;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.95);
    box-shadow: inset 0 0 0 1px rgba(11, 126, 214, 0.2);
    transform: translateX(0);
    width: 90px;
    transition: transform 0.22s cubic-bezier(0.2, 0.8, 0.2, 1), width 0.22s cubic-bezier(0.2, 0.8, 0.2, 1);
    z-index: 0;
  }

  .petitions-item {
    position: relative;
    z-index: 1;
    border: 0;
    background: transparent;
    color: #fff;
    padding: 10px 14px;
    border-radius: 12px;
    cursor: pointer;
    font: 600 13px/1 system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;
    letter-spacing: 0.02em;
    transition: color 0.16s ease;
  }

  .petitions-item.petitions-highlighted,
  .petitions-item.petitions-highlighted.is-active {
    color: #0b7ed6;
  }

  .petitions-item:hover,
  .petitions-item:focus {
    color: #0b7ed6;
  }

  .petitions-item.is-active {
    color: #fff;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('file-preview-modal');
  const content = document.getElementById('file-preview-content');
  const closeBtn = document.getElementById('file-preview-close');
  let currentObjectUrl = null;
  if (!modal || !content || !closeBtn) return;

  const normalizeFileText = (text) => {
    if (text == null) {
      return '';
    }
    return String(text)
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .replace(/\s+/g, ' ')
      .trim()
      .toLowerCase();
  };

  const isMonitoriaBaseName = (text) => {
    const normalized = normalizeFileText(text);
    return (
      normalized.includes('01 - monitoria inicial') ||
      normalized.includes('01 - cobranca judicial')
      || normalized.includes('habilitacao')
      || normalized.includes('habilitação')
    );
  };

  const getRowFileNameText = (row) => {
    if (!row) return '';
    const nameInput = row.querySelector('input[name$="-nome"]');
    if (nameInput && nameInput.value) {
      return nameInput.value;
    }
    const nomeCell = row.querySelector('td.field-nome');
    return nomeCell ? nomeCell.textContent : '';
  };

  // Botões "Baixar Doc Editável" e "Baixar PDF" na aba Arquivos + transformar links em "Visualizar"
  // Converte links de arquivo em botão "Visualizar" (apenas no campo de arquivo)
  (function applyVisualizarButtons() {
    const apply = () => {
      const fileLinks = document.querySelectorAll('#arquivos-group td.field-arquivo a[href], #processoarquivo_set-group td.field-arquivo a[href]');
      fileLinks.forEach(link => {
        if (link.dataset.visualizarApplied === '1') return;
        // não mexe no botão de adicionar novo arquivo
        if (link.closest('.add-row')) return;
        link.textContent = 'Visualizar';
        link.classList.add('button');
        link.style.backgroundColor = '#555';
        link.style.color = '#fff';
        link.style.padding = '3px 7px';
        link.style.fontSize = '0.85em';
        link.style.display = 'inline-block';
        link.style.marginTop = '4px';
        link.dataset.visualizarApplied = '1';
      });

      // Remove o prefixo "Atualmente:" / "Currently:" do widget de upload
      document.querySelectorAll('#arquivos-group p.file-upload, #processoarquivo_set-group p.file-upload').forEach(p => {
        const txtNode = Array.from(p.childNodes).find(n => n.nodeType === Node.TEXT_NODE && n.textContent.trim().match(/Atualmente:|Currently:/i));
        if (txtNode) {
          txtNode.textContent = '';
        }
      });
    };
    apply();
    const observer = new MutationObserver(apply);
    observer.observe(document.body, { childList: true, subtree: true });
  })();

  function closeModal() {
    modal.style.display = 'none';
    content.innerHTML = '';
    if (currentObjectUrl) {
      URL.revokeObjectURL(currentObjectUrl);
      currentObjectUrl = null;
    }
  }

  closeBtn.addEventListener('click', closeModal);
  modal.addEventListener('click', function(e) {
    if (e.target === modal) closeModal();
  });

  // Variáveis globais para o visualizador PDF
  let pdfDoc = null;
  let pageNum = 1;
  let pageRendering = false;
  let pageNumPending = null;
  let scale = 1.5;
  let canvas = null;
  let ctx = null;

  function renderFile(href) {
    console.log('[DEBUG] renderFile chamado com href:', href);
    if (!href) return;
    const isImage = /\.(png|jpe?g|gif|webp|bmp)$/i.test(href);
    const isPdf = /\.pdf$/i.test(href) || /\/convert-to-pdf\/?/.test(href);
    console.log('[DEBUG] isImage:', isImage, 'isPdf:', isPdf);
    if (!isImage && !isPdf) {
      console.log('[DEBUG] Arquivo não é imagem nem PDF, abortando');
      return;
    }

    if (currentObjectUrl) {
      URL.revokeObjectURL(currentObjectUrl);
      currentObjectUrl = null;
    }

    if (isImage) {
      content.innerHTML = `<img src="${href}" alt="Pré-visualização" style="max-width:100%; max-height:80vh; display:block; margin:0 auto;">`;
      modal.style.display = 'flex';
      return;
    }

    // Renderiza PDF usando PDF.js e canvas
    content.innerHTML = `
      <div style="display:flex; flex-direction:column; gap:12px; align-items:center; width:80vw;">
        <p style="color:#555; text-align:center; margin:0;">Carregando PDF...</p>
      </div>`;
    modal.style.display = 'flex';
    console.log('[DEBUG] Modal aberto, fazendo fetch do PDF...');

    fetch(href).then(res => {
      console.log('[DEBUG] Fetch resposta:', res.status, res.statusText);
      if (!res.ok) throw new Error('Falha ao carregar PDF: ' + res.status);
      return res.arrayBuffer();
    }).then(arrayBuffer => {
      console.log('[DEBUG] ArrayBuffer recebido, tamanho:', arrayBuffer.byteLength);
      return pdfjsLib.getDocument({data: arrayBuffer}).promise;
    }).then(pdf => {
      console.log('[DEBUG] PDF carregado, páginas:', pdf.numPages);
      pdfDoc = pdf;
      pageNum = 1;

      // Cria estrutura HTML com canvas e controles
      content.innerHTML = `
        <div style="display:flex; flex-direction:column; gap:12px; align-items:center; width:80vw;">
          <div style="background:#f5f5f5; padding:8px; border-radius:4px; display:flex; gap:12px; align-items:center;">
            <button id="pdf-prev" class="button" style="padding:6px 12px;">← Anterior</button>
            <span id="pdf-page-info" style="font-size:0.95em; color:#333;">Página <span id="pdf-page-num">1</span> de <span id="pdf-page-count">${pdf.numPages}</span></span>
            <button id="pdf-next" class="button" style="padding:6px 12px;">Próxima →</button>
            <button id="pdf-zoom-out" class="button" style="padding:6px 12px; margin-left:12px;">-</button>
            <span style="font-size:0.9em; color:#666;">Zoom: <span id="pdf-zoom-level">150</span>%</span>
            <button id="pdf-zoom-in" class="button" style="padding:6px 12px;">+</button>
          </div>
          <div style="overflow:auto; max-height:75vh; border:1px solid #ddd; background:#fff;">
            <canvas id="pdf-canvas"></canvas>
          </div>
        </div>`;

      canvas = document.getElementById('pdf-canvas');
      ctx = canvas.getContext('2d');

      // Eventos dos botões
      document.getElementById('pdf-prev').addEventListener('click', () => {
        if (pageNum <= 1) return;
        pageNum--;
        queueRenderPage(pageNum);
      });

      document.getElementById('pdf-next').addEventListener('click', () => {
        if (pageNum >= pdf.numPages) return;
        pageNum++;
        queueRenderPage(pageNum);
      });

      document.getElementById('pdf-zoom-in').addEventListener('click', () => {
        scale = Math.min(scale + 0.25, 3.0);
        document.getElementById('pdf-zoom-level').textContent = Math.round(scale * 100);
        queueRenderPage(pageNum);
      });

      document.getElementById('pdf-zoom-out').addEventListener('click', () => {
        scale = Math.max(scale - 0.25, 0.5);
        document.getElementById('pdf-zoom-level').textContent = Math.round(scale * 100);
        queueRenderPage(pageNum);
      });

      // Renderiza primeira página
      renderPage(pageNum);

    }).catch((err) => {
      console.error('[DEBUG] Erro ao carregar PDF:', err);
      content.innerHTML = `
        <div style="display:flex; flex-direction:column; gap:12px; align-items:center; justify-content:center;">
          <p style="color:#c00;">Não foi possível pré-visualizar o PDF.</p>
          <p style="color:#999; font-size:0.9em;">${err.message}</p>
        </div>`;
    });
  }

  function renderPage(num) {
    pageRendering = true;
    pdfDoc.getPage(num).then(page => {
      const viewport = page.getViewport({scale: scale});
      canvas.height = viewport.height;
      canvas.width = viewport.width;

      const renderContext = {
        canvasContext: ctx,
        viewport: viewport
      };

      const renderTask = page.render(renderContext);
      renderTask.promise.then(() => {
        pageRendering = false;
        if (pageNumPending !== null) {
          renderPage(pageNumPending);
          pageNumPending = null;
        }
        document.getElementById('pdf-page-num').textContent = num;

        // Atualiza estado dos botões
        const prevBtn = document.getElementById('pdf-prev');
        const nextBtn = document.getElementById('pdf-next');
        if (prevBtn) prevBtn.disabled = (num <= 1);
        if (nextBtn) nextBtn.disabled = (num >= pdfDoc.numPages);
      });
    });
  }

  function queueRenderPage(num) {
    if (pageRendering) {
      pageNumPending = num;
    } else {
      renderPage(num);
    }
  }

  function showZipPreview(href, label) {
    if (!href) return;
    const fileName = label || href.split('/').pop() || 'arquivo.zip';
    const safeName = escapeHtml(fileName);
    content.innerHTML = `
      <div style="max-width:480px; text-align:left; display:flex; flex-direction:column; gap:12px;">
        <h3 style="margin:0 0 6px;font-size:1.1rem;">Pré-visualização do ZIP</h3>
        <p style="margin:0; color:#333;">Arquivo: <strong>${safeName}</strong></p>
        <p style="margin:0; color:#555;">Use o botão abaixo para baixar o pacote finalizado.</p>
        <a href="${href}" target="_blank" rel="noopener" class="button" style="background:#1c7ed6; border-color:#1660af; padding:6px 12px; font-weight:600;">Baixar ZIP</a>
      </div>`;
    modal.style.display = 'flex';
  }

  document.body.addEventListener('click', function(e) {
    const link = e.target.closest('a');
    if (!link) return;
    if (link.dataset.skipPreview === '1' || link.hasAttribute('download')) return;
    const href = link.getAttribute('href') || '';

    // Suporta visualização de PDFs convertidos via /convert-to-pdf/
    if (/\/contratos\/arquivo\/\d+\/convert-to-pdf\/?(\?.*)?$/.test(href) && !/download=1/.test(href)) {
      console.log('[DEBUG] Interceptado link convert-to-pdf:', href);
      e.preventDefault();
      console.log('[DEBUG] Chamando renderFile...');
      renderFile(href);
      return;
    }

    // Apenas links de arquivo da pasta do processo
    if (!/\/media\/processos\//.test(href) && !/processos\/[\d]+\/pasta\//.test(href)) return;
    // Extensões suportadas (imagens, PDFs; DOCX tenta abrir o PDF-irmão, senão alerta)
    const isImage = /\.(png|jpe?g|gif|webp|bmp)$/i.test(href);
    const isPdf = /\.pdf$/i.test(href);
    const isDocx = /\.docx$/i.test(href);
    const isZip = /\.zip$/i.test(href);
    if (!isImage && !isPdf && !isDocx && !isZip) return;

    if (isDocx) {
      const pdfHref = href.replace(/\.docx$/i, '.pdf');
      fetch(pdfHref, { method: 'HEAD' })
        .then(res => {
          if (res.ok) {
            renderFile(pdfHref);
          } else {
            alert('Pré-visualização disponível apenas em PDF. Gere/aguarde o PDF na aba Arquivos.');
          }
        })
        .catch(() => {
          alert('Pré-visualização disponível apenas em PDF. Gere/aguarde o PDF na aba Arquivos.');
        });
      return;
    }

    if (isZip) {
      const wantsPreview = link.dataset.zipPreview === '1';
      if (wantsPreview) {
        e.preventDefault();
        showZipPreview(href, link.closest('tr') ? getRowFileNameText(link.closest('tr')) : null);
        return;
      }
      return;
    }

    if (isImage || isPdf) {
      e.preventDefault();
      renderFile(href);
    }
  }, true);

  // Insere botões de Visualizar / PDF / DOC nos arquivos do tipo Monitória/Cobrança e Visualizar/Baixar nos demais
  ;(function injectDownloadButtons() {
    const arquivosGroup = document.querySelector('#arquivos-group') || document.querySelector('#processoarquivo_set-group');
    if (!arquivosGroup) return;

    const createButton = (text, href, opts = {}) => {
      const btn = document.createElement('a');
      btn.href = href;
      btn.textContent = text;
      btn.className = 'button';
        btn.style.padding = '4px 7px';
        btn.style.background = '#555';
        btn.style.color = '#fff';
        btn.style.border = '1px solid #444';
        btn.style.boxShadow = 'none';
        btn.style.fontWeight = '400';
        btn.style.fontSize = '0.85em';
        if (opts.preview) {
        btn.dataset.zipPreview = '1';
      }
      if (opts.download) {
        btn.setAttribute('download', '');
        btn.dataset.skipPreview = '1';
      }
      const openInNewTab = Boolean(opts.openInNewTab);
      if (openInNewTab) {
        btn.dataset.skipPreview = '1';
        btn.addEventListener('click', function(ev) {
          ev.preventDefault();
          window.open(href, '_blank');
        });
      }
      return btn;
    };

    const isMonitoriaRow = (row) => {
      const text = getRowFileNameText(row);
      return isMonitoriaBaseName(text);
    };

    const swapFileExtension = (href, fromExt, toExt) => {
      if (!href) return href;
      const hashIndex = href.indexOf('#');
      const queryIndex = href.indexOf('?');
      const cutIndex = (hashIndex === -1) ? queryIndex : (queryIndex === -1 ? hashIndex : Math.min(hashIndex, queryIndex));
      const base = cutIndex === -1 ? href : href.slice(0, cutIndex);
      const suffix = cutIndex === -1 ? '' : href.slice(cutIndex);
      const normalized = base.replace(new RegExp(`${fromExt}$`, 'i'), toExt);
      return normalized + suffix;
    };

    const getRowArquivoId = (row) => {
      if (!row) return null;
      const idInput = row.querySelector('input[name$="-id"]');
      const rawId = idInput ? idInput.value : '';
      return rawId ? rawId : null;
    };

    const createBaseBadge = (baseCheckbox) => {
      const wrapper = document.createElement('label');
      wrapper.className = 'monitoria-checkbox-wrapper';
      const label = document.createElement('span');
      label.textContent = 'Base';
      wrapper.appendChild(label);
      const syncWrapper = () => {
        const checked = Boolean(baseCheckbox.checked);
        wrapper.classList.toggle('checked', checked);
        label.classList.toggle('base-active', checked);
      };
      baseCheckbox.addEventListener('change', syncWrapper);
      syncWrapper();
      return wrapper;
    };

    const attachBaseBadge = (row, btnRow, attempt = 0) => {
      if (!row || row.dataset.monitoriaBadgeAdded === '1' || attempt > 10) {
        return;
      }
      const baseCheckbox = row.querySelector('.arquivos-peticoes-base-checkbox');
      if (!baseCheckbox) {
        setTimeout(() => {
          attachBaseBadge(row, btnRow, attempt + 1);
        }, 80);
        return;
      }
      const badge = createBaseBadge(baseCheckbox);
      btnRow.appendChild(badge);
      row.dataset.monitoriaBadgeAdded = '1';
    };

    const getUploaderName = (row) => {
      const cell = row.querySelector('td.field-enviado_por');
      if (!cell) {
        return '';
      }
      const input = cell.querySelector('input[type="text"]');
      if (input && input.value.trim()) {
        return input.value.trim();
      }
      const select = cell.querySelector('select');
      if (select) {
        const selected = select.selectedOptions[0];
        if (selected && selected.textContent.trim()) {
          return selected.textContent.trim();
        }
      }
      const linkText = cell.querySelector('a');
      if (linkText && linkText.textContent.trim()) {
        return linkText.textContent.trim();
      }
      const raw = cell.textContent || '';
      return raw.trim();
    };

    const getCreationDate = (row) => {
      const cell = row.querySelector('td.field-criado_em');
      if (!cell) {
        return '';
      }
      const raw = cell.textContent || '';
      return raw.trim().replace(/\s+/g, ' ');
    };

    const renderUploaderLine = (row, nomeCell) => {
      if (!row || !nomeCell) {
        return;
      }
      let uploaderLine = row.querySelector('.documento-peticoes-uploader-line');
      if (!uploaderLine) {
        uploaderLine = document.createElement('div');
        uploaderLine.className = 'documento-peticoes-uploader-line';
        nomeCell.appendChild(uploaderLine);
      }
      const name = getUploaderName(row);
      const dateText = getCreationDate(row);
      if (!name && !dateText) {
        uploaderLine.style.display = 'none';
        return;
      }
      let text = 'Enviado';
      if (name) {
        text += ` por ${name}`;
      }
      if (dateText) {
        text += name ? ` em ${dateText}` : ` em ${dateText}`;
      }
      uploaderLine.textContent = text;
      uploaderLine.style.display = 'block';
    };

    const setupModifyControl = (row, arquivoCell, hasFileLink = false) => {
      if (!row || row.dataset.modifyControlAdded === '1' || !arquivoCell) {
        return;
      }
      const fileUpload = arquivoCell.querySelector('p.file-upload');
      const fileInput = arquivoCell.querySelector('input[type="file"]');
      const nomeCell = row.querySelector('td.field-nome');
      if (!nomeCell) {
        return;
      }
      if (!fileInput) {
        return;
      }
      if (fileUpload) {
        Array.from(fileUpload.childNodes).forEach(node => {
          if (node.nodeType === Node.TEXT_NODE) {
            node.textContent = '';
          }
        });
      }
      const modifyRow = document.createElement('div');
      modifyRow.className = 'documento-peticoes-modify-row';
      const label = document.createElement('span');
      label.textContent = hasFileLink ? 'Modificar:' : 'Procurar:';
      label.style.fontWeight = '600';
      const button = document.createElement('button');
      button.type = 'button';
      button.className = 'button button-secondary';
      button.textContent = 'Procurar...';
      button.addEventListener('click', (event) => {
        event.preventDefault();
        if (fileInput) {
          fileInput.click();
        }
      });
      modifyRow.appendChild(label);
      modifyRow.appendChild(button);
      nomeCell.appendChild(modifyRow);
      renderUploaderLine(row, nomeCell);
      if (fileUpload) {
        fileUpload.style.display = 'none';
      }
      row.dataset.modifyControlAdded = '1';
    };

    const createConfirmOverlay = (message) => {
      let overlay = document.getElementById('arquivo-delete-confirm-overlay');
      if (overlay) {
        overlay.remove();
      }
      overlay = document.createElement('div');
      overlay.id = 'arquivo-delete-confirm-overlay';
      overlay.style.position = 'fixed';
      overlay.style.inset = '0';
      overlay.style.backgroundColor = 'rgba(0,0,0,0.4)';
      overlay.style.display = 'flex';
      overlay.style.alignItems = 'center';
      overlay.style.justifyContent = 'center';
      overlay.style.zIndex = '10001';
      const card = document.createElement('div');
      card.style.background = '#fff';
      card.style.padding = '20px';
      card.style.borderRadius = '10px';
      card.style.maxWidth = '320px';
      card.style.textAlign = 'center';
      card.style.boxShadow = '0 12px 30px rgba(0,0,0,0.3)';
      const label = document.createElement('p');
      label.textContent = message;
      label.style.marginBottom = '20px';
      card.appendChild(label);
      const actions = document.createElement('div');
      actions.style.display = 'flex';
      actions.style.justifyContent = 'center';
      actions.style.gap = '12px';
      const btnSim = document.createElement('button');
      btnSim.type = 'button';
      btnSim.textContent = 'Sim';
      btnSim.className = 'button button-primary';
      const btnCancelar = document.createElement('button');
      btnCancelar.type = 'button';
      btnCancelar.textContent = 'Cancelar';
      btnCancelar.className = 'button button-secondary';
      actions.appendChild(btnCancelar);
      actions.appendChild(btnSim);
      card.appendChild(actions);
      overlay.appendChild(card);
      document.body.appendChild(overlay);
      return { overlay, btnSim, btnCancelar };
    };

    const appendRemoveButton = (row, container) => {
      if (!row || !container || row.dataset.removeBtnAdded === '1') {
        return;
      }
      const deleteCheckbox = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
      if (!deleteCheckbox) {
        return;
      }
      deleteCheckbox.style.display = 'none';
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'button';
      btn.textContent = '×';
      btn.title = 'Remover arquivo';
      btn.style.backgroundColor = '#d63636';
      btn.style.color = '#fff';
      btn.style.borderRadius = '999px';
      btn.style.width = '20px';
      btn.style.height = '20px';
      btn.style.border = 'none';
      btn.style.display = 'flex';
      btn.style.alignItems = 'center';
      btn.style.justifyContent = 'center';
      btn.style.fontSize = '1.1rem';
      btn.style.cursor = 'pointer';
      const nomeCell = row.querySelector('td.field-nome');
      const fileName = (row.querySelector('input[name$="-nome"]')?.value || nomeCell?.textContent || 'arquivo').trim();
      btn.addEventListener('click', (event) => {
        event.preventDefault();
        const { overlay, btnSim, btnCancelar } = createConfirmOverlay(`Confirmar deletar o arquivo "${fileName}"?`);
        const cleanUp = () => {
          overlay.remove();
          btnSim.removeEventListener('click', simHandler);
          btnCancelar.removeEventListener('click', cancelHandler);
        };
        const simHandler = () => {
          deleteCheckbox.checked = true;
          row.style.display = 'none';
          cleanUp();
        };
        const cancelHandler = () => {
          cleanUp();
        };
        btnSim.addEventListener('click', simHandler);
        btnCancelar.addEventListener('click', cancelHandler);
      });
      container.appendChild(btn);
      row.dataset.removeBtnAdded = '1';
    };

    const processRow = (row) => {
      if (row.dataset.downloadButtonsInjected === '1') {
        return;
      }
      const arquivoCell = row.querySelector('td.field-arquivo');
      if (!arquivoCell) {
        return;
      }
      const link = arquivoCell.querySelector('a[href*="/media/"], a[href*="processos/"]');
      setupModifyControl(row, arquivoCell, Boolean(link));
      if (!link) {
        return;
      }
      link.style.display = 'none';

      const actionBar = document.createElement('div');
      actionBar.className = 'documento-peticoes-action-bar';
      actionBar.style.display = 'flex';
      actionBar.style.justifyContent = 'flex-end';
      actionBar.style.gap = '6px';
      actionBar.style.marginBottom = '6px';

      const btnRow = document.createElement('div');
      btnRow.className = 'documento-peticoes-download-row';
      btnRow.style.display = 'flex';
      btnRow.style.flexWrap = 'nowrap';
      btnRow.style.gap = '6px';
      btnRow.style.margin = '6px 0 4px 0';
      btnRow.style.alignItems = 'center';
      btnRow.style.width = '100%';
      btnRow.style.justifyContent = 'space-between';

      const leftGroup = document.createElement('div');
      leftGroup.style.display = 'flex';
      leftGroup.style.flexWrap = 'wrap';
      leftGroup.style.gap = '6px';
      const isProtocolRowEntry = isProtocolRow(row);
      const isZipFile = /\.zip$/i.test(link.href);
      const visualizarOpts = isProtocolRowEntry && isZipFile ? { preview: true } : {};
      const arquivoId = getRowArquivoId(row);
      const visualizarHref = arquivoId
        ? `/contratos/arquivo/${arquivoId}/convert-to-pdf/`
        : link.href;
      // Para monitória, usa o proxy_arquivo_view para visualização inline
      const visualizarOpts2 = isMonitoriaRow(row) && !isZipFile ? { openInNewTab: false } : visualizarOpts;
      leftGroup.appendChild(createButton('Visualizar', visualizarHref, visualizarOpts2));
      if (isMonitoriaRow(row)) {
        const pdfHref = arquivoId
          ? `/contratos/arquivo/${arquivoId}/convert-to-pdf/?download=1`
          : swapFileExtension(link.href, '\\.docx', '.pdf');
        const docHref = arquivoId
          ? `/contratos/arquivo/${arquivoId}/convert-to-docx/`
          : swapFileExtension(link.href, '\\.pdf', '.docx');
        leftGroup.appendChild(createButton('PDF', pdfHref, { download: true }));
        leftGroup.appendChild(createButton('DOC', docHref, { download: true }));
        attachBaseBadge(row, leftGroup);
      } else {
        leftGroup.appendChild(createButton('Baixar', link.href, { download: true }));
      }

      const rightGroup = document.createElement('div');
      rightGroup.style.display = 'flex';
      rightGroup.style.alignItems = 'center';

      btnRow.appendChild(leftGroup);
      btnRow.appendChild(rightGroup);

      const nomeCell = row.querySelector('td.field-nome');
      if (nomeCell) {
        nomeCell.appendChild(actionBar);
        nomeCell.appendChild(btnRow);
      } else {
        row.appendChild(actionBar);
        row.appendChild(btnRow);
      }

      appendRemoveButton(row, actionBar);

      const shouldShowToggle =
        (isProtocolRowEntry || isHabilitacaoRow(row)) && !row.dataset.protocolToggleAdded;
      const protocolCheckbox = row.querySelector('input[type="checkbox"][name$="-protocolado_no_tribunal"]');
      if (shouldShowToggle && protocolCheckbox) {
        const toggle = createProtocolToggle(protocolCheckbox);
        if (toggle) {
          rightGroup.appendChild(toggle);
          row.dataset.protocolToggleAdded = '1';
        }
      }
      row.dataset.downloadButtonsInjected = '1';
    };

    const normalizeNameForProtocol = (text) => {
      if (!text) {
        return '';
      }
      return text
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/\s+/g, ' ')
        .trim()
        .toLowerCase();
    };
    const isProtocolRow = (row) => {
      if (!row) return false;
      const name = getRowFileNameText(row);
      if (!name) return false;
      return normalizeNameForProtocol(name).includes('protocolo');
    };
    const isHabilitacaoRow = (row) => {
      if (!row) return false;
      const name = getRowFileNameText(row);
      return name && normalizeNameForProtocol(name).includes('habilitacao');
    };

    const createProtocolToggle = (checkbox) => {
      if (!checkbox) {
        return null;
      }
      checkbox.style.display = 'none';
      checkbox.dataset.protocolToggleManaged = '1';
      const wrapper = document.createElement('label');
      wrapper.className = 'protocol-toggle';
      wrapper.title = 'Ative ao confirmar o protocolo no tribunal';
      wrapper.setAttribute('aria-pressed', 'false');
      const switchEl = document.createElement('span');
      switchEl.className = 'supervision-switch';
      const labelText = document.createElement('span');
      labelText.className = 'supervision-label-text';
      labelText.textContent = 'Confirma Protocolo no Tribunal';
      wrapper.appendChild(switchEl);
      wrapper.appendChild(labelText);

      const updateState = () => {
        const checked = Boolean(checkbox.checked);
        wrapper.classList.toggle('protocol-toggle--active', checked);
        wrapper.classList.toggle('protocol-toggle--inactive', !checked);
        wrapper.setAttribute('aria-pressed', checked ? 'true' : 'false');
      };

      const toggleState = (event) => {
        event.preventDefault();
        checkbox.checked = !checkbox.checked;
        checkbox.dispatchEvent(new Event('change', { bubbles: true }));
        updateState();
        setTimeout(() => {
          clickSaveAndContinueEditor();
        }, 150);
      };

      wrapper.addEventListener('click', toggleState);
      checkbox.addEventListener('change', updateState);
      updateState();
      return wrapper;
    };

    const tryInsert = () => {
      const rows = arquivosGroup.querySelectorAll('tr.dynamic-processoarquivo, tr.dynamic-arquivos');
      rows.forEach(processRow);
    };

    tryInsert();
    const observer = new MutationObserver(tryInsert);
    observer.observe(arquivosGroup, { childList: true, subtree: true });
  })();


  // Substitui o checkbox de remoção por botão “×” vermelho com confirmação customizada
  (function enhanceArquivoInlineDeletes() {
    const inlineGroup = document.querySelector('#processoarquivo_set-group');
    if (!inlineGroup) return;

    const createConfirmOverlay = (message) => {
      let overlay = document.getElementById('arquivo-delete-confirm-overlay');
      if (overlay) {
        overlay.remove();
      }
      overlay = document.createElement('div');
      overlay.id = 'arquivo-delete-confirm-overlay';
      overlay.style.position = 'fixed';
      overlay.style.inset = '0';
      overlay.style.backgroundColor = 'rgba(0,0,0,0.4)';
      overlay.style.display = 'flex';
      overlay.style.alignItems = 'center';
      overlay.style.justifyContent = 'center';
      overlay.style.zIndex = '10001';
      const card = document.createElement('div');
      card.style.background = '#fff';
      card.style.padding = '20px';
      card.style.borderRadius = '10px';
      card.style.maxWidth = '320px';
      card.style.textAlign = 'center';
      card.style.boxShadow = '0 12px 30px rgba(0,0,0,0.3)';
      const label = document.createElement('p');
      label.textContent = message;
      label.style.marginBottom = '20px';
      card.appendChild(label);
      const actions = document.createElement('div');
      actions.style.display = 'flex';
      actions.style.justifyContent = 'center';
      actions.style.gap = '12px';
      const btnSim = document.createElement('button');
      btnSim.type = 'button';
      btnSim.textContent = 'Sim';
      btnSim.className = 'button button-primary';
      const btnCancelar = document.createElement('button');
      btnCancelar.type = 'button';
      btnCancelar.textContent = 'Cancelar';
      btnCancelar.className = 'button button-secondary';
      actions.appendChild(btnCancelar);
      actions.appendChild(btnSim);
      card.appendChild(actions);
      overlay.appendChild(card);
      document.body.appendChild(overlay);
      return { overlay, btnSim, btnCancelar };
    };

    const attachRemoveButton = (row) => {
      if (row.dataset.removeBtnAdded) return;
      const deleteCheckbox = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
      if (!deleteCheckbox) return;
      deleteCheckbox.style.display = 'none';
      const nomeCell = row.querySelector('td.field-nome');
      if (!nomeCell) return;
      let wrapper = row.querySelector('.documento-peticoes-remove-wrapper');
      if (!wrapper) {
        wrapper = document.createElement('div');
        wrapper.className = 'documento-peticoes-remove-wrapper';
        nomeCell.appendChild(wrapper);
      }
      wrapper.innerHTML = '';
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'button';
      btn.textContent = '×';
      btn.title = 'Remover arquivo';
      btn.style.backgroundColor = '#d63636';
      btn.style.color = '#fff';
      btn.style.borderRadius = '999px';
      btn.style.width = '28px';
      btn.style.height = '28px';
      btn.style.border = 'none';
      btn.style.fontSize = '1.2rem';
      btn.style.cursor = 'pointer';
      const fileName = (row.querySelector('input[name$="-nome"]')?.value || nomeCell.textContent || 'arquivo').trim();
      btn.addEventListener('click', (event) => {
        event.preventDefault();
        const { overlay, btnSim, btnCancelar } = createConfirmOverlay(`Confirmar deletar o arquivo "${fileName}"?`);
        const cleanUp = () => {
          overlay.remove();
          btnSim.removeEventListener('click', simHandler);
          btnCancelar.removeEventListener('click', cancelHandler);
        };
        const simHandler = () => {
          deleteCheckbox.checked = true;
          row.style.display = 'none';
          cleanUp();
        };
        const cancelHandler = () => {
          cleanUp();
        };
        btnSim.addEventListener('click', simHandler);
        btnCancelar.addEventListener('click', cancelHandler);
      });
      wrapper.appendChild(btn);
      row.dataset.removeBtnAdded = '1';
    };

    const init = () => {
      inlineGroup.querySelectorAll('.dynamic-processoarquivo, .dynamic-arquivos').forEach(attachRemoveButton);
    };

    init();
  })();

  (function hideArquivoHeaders() {
    const selectors = [
      '#arquivos-group thead th',
      '#processoarquivo_set-group thead th'
    ];
    selectors.forEach(selector => {
      document.querySelectorAll(selector).forEach(th => {
        const text = (th.textContent || '').trim().toLowerCase();
        if (!text) return;
        if (text.includes('arquivo') || text.includes('remover')) {
          th.style.display = 'none';
        }
      });
    });
  })();

});
</script>
{% endblock %}
