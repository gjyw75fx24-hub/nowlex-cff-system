{% extends "admin/contratos/processojudicial/change_form_etiquetas.html" %}
{% load i18n static %}

{% block extrahead %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'admin/css/documento_modelo_peticoes.css' %}">
<!-- Mammoth.js para visualização de DOCX -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
<!-- PDF.js para visualização de PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
  if (window.pdfjsLib) {
    window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  }
</script>
<script>
window.__analise_is_supervisor = {{ is_supervisor|default_if_none:False|yesno:"true,false" }};
window.__tipos_peticao_api_url = "{{ tipos_peticao_api_url|default:'' }}";
window.__tipos_peticao_preview_url = "{{ tipos_peticao_preview_url|default:'' }}";
window.__tipos_peticao_generate_url = "{{ tipos_peticao_generate_url|default:'' }}";
window.__tipos_peticao_csrf_token = "{{ csrf_token|default:'' }}";
</script>
{% endblock %}

{% block content %}
<div class="navigation-buttons" style="text-align: right; margin-bottom: 10px;">
  {% if prev_obj_url %}
    <a href="{{ prev_obj_url }}" class="button" style="font-size: 1.2em; padding: 5px 10px; margin-right: 5px; background: none; border: none; box-shadow: none; color: #417690;"><</a>
  {% else %}
    <span class="button disabled" style="font-size: 1.2em; padding: 5px 10px; margin-right: 5px; background: none; border: none; box-shadow: none; color: #ccc; cursor: default;"> < </span>
  {% endif %}
  
  {% if next_obj_url %}
    <a href="{{ next_obj_url }}" class="button" style="font-size: 1.2em; padding: 5px 10px; background: none; border: none; box-shadow: none; color: #417690;"> > </a>
  {% else %}
    <span class="button disabled" style="font-size: 1.2em; padding: 5px 10px; background: none; border: none; box-shadow: none; color: #ccc; cursor: default;"> > </span>
  {% endif %}
</div>
{{ block.super }} {# Render the content from the parent template #}

<div id="file-preview-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:10000; align-items:center; justify-content:center;">
  <div id="file-preview-content" style="background:#fff; padding:12px; border-radius:6px; max-width:90%; max-height:90%; position:relative; box-shadow:0 8px 24px rgba(0,0,0,0.25);"></div>
  <button id="file-preview-close" style="position:absolute; top:12px; right:16px; background:#444; color:#fff; border:none; padding:6px 10px; border-radius:4px; cursor:pointer;">Fechar</button>
</div>

<style>
  #processoarquivo_set-group th.delete,
  #processoarquivo_set-group td.delete,
  #processoarquivo_set-group th.column-delete,
  #processoarquivo_set-group td.column-delete,
  #processoarquivo_set-group th.column-arquivo,
  #arquivos-group th.delete,
  #arquivos-group td.delete,
  #arquivos-group th.column-delete,
  #arquivos-group td.column-delete,
  #arquivos-group th.column-arquivo,
  #arquivos-group td.field-arquivo,
  #arquivos-group table thead th:nth-child(3),
  #arquivos-group table tbody td:nth-child(3),
  #arquivos-group table thead th:nth-child(4),
  #arquivos-group table tbody td:nth-child(4) {
    display: none !important;
  }
  #arquivos-group table tbody tr.add-row td.field-arquivo,
  #processoarquivo_set-group table tbody tr.add-row td.field-arquivo {
    display: table-cell !important;
  }

.monitoria-checkbox-wrapper {
  display: inline-flex;
  align-items: center;
  margin-left: 10px;
}

.monitoria-checkbox-wrapper input[type="checkbox"] {
  display: none;
}

.monitoria-checkbox-wrapper span {
  font-size: 0.85rem;
  letter-spacing: 0.04em;
  padding: 6px 18px;
  border-radius: 10px;
  border: 1px solid #cbd5e0;
  background: #ffffff;
  color: #42748fff;
  font-weight: 600;
  cursor: pointer;
  box-shadow: inset 0 -1px 0 rgba(0, 0, 0, 0.08);
  transition: background 0.2s ease, color 0.2s ease, border 0.2s ease, transform 0.15s ease;
}

.monitoria-checkbox-wrapper span:focus-visible {
  outline: 2px solid rgba(66, 116, 143, 0.6);
  outline-offset: 2px;
}

.monitoria-checkbox-wrapper input[type="checkbox"]:checked + span,
.monitoria-checkbox-wrapper.checked span {
  border-color: #42748fff;
  background: #42748fff;
  color: #ffffff;
  box-shadow: 0 6px 12px rgba(66, 116, 143, 0.2);
  transform: translateY(-1px);
}
.documento-peticoes-remove-wrapper {
  display: flex;
  justify-content: flex-end;
  margin-top: 6px;
}

.documento-peticoes-modify-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 6px;
}

.documento-peticoes-modify-row .button {
  padding: 3px 10px;
  font-size: 0.85em;
}
 .documento-peticoes-modify-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 6px;
}

.documento-peticoes-modify-row .button {
  padding: 3px 10px;
  font-size: 0.85em;
}

.documento-peticoes-uploader-line {
  font-size: 0.8rem;
  color: #5f6b7a;
  margin-top: 4px;
  text-transform: capitalize;
}

#arquivos-group th.column-enviado_por,
#processoarquivo_set-group th.column-enviado_por,
#arquivos-group td.field-enviado_por,
#processoarquivo_set-group td.field-enviado_por,
#arquivos-group th.column-criado_em,
#processoarquivo_set-group th.column-criado_em,
#arquivos-group td.field-criado_em,
#processoarquivo_set-group td.field-criado_em,
#arquivos-group th.column-protocolado_no_tribunal,
#processoarquivo_set-group th.column-protocolado_no_tribunal,
#arquivos-group td.field-protocolado_no_tribunal,
#processoarquivo_set-group td.field-protocolado_no_tribunal {
  display: none;
}

  .petitions-wrap {
    position: relative;
    display: inline-flex;
    align-items: center;
    margin-left: auto;
  }

  .petitions-trigger {
    border: 1px solid rgba(11, 126, 214, 0.3);
    background: #0b7ed6;
    color: #fff;
    padding: 10px 14px;
    border-radius: 12px;
    cursor: pointer;
    font: 600 13px/1 system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;
    letter-spacing: 0.02em;
  }

  .petitions-panel {
    position: absolute;
    right: 0;
    top: calc(100% + 10px);
    opacity: 0;
    transform: translateY(-6px);
    pointer-events: none;
    transition: opacity 0.18s ease, transform 0.18s ease;
    z-index: 1000;
  }

  .petitions-panel.open {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }

  .petitions-rail {
    position: relative;
    display: flex;
    gap: 12px;
    padding: 12px;
    border-radius: 16px;
    background: #0b7ed6;
    border: 1px solid rgba(11, 126, 214, 0.6);
    box-shadow: 0 16px 40px rgba(11, 126, 214, 0.3);
  }

  .petitions-indicator {
    position: absolute;
    top: 8px;
    bottom: 8px;
    left: 12px;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.95);
    box-shadow: inset 0 0 0 1px rgba(11, 126, 214, 0.2);
    transform: translateX(0);
    width: 90px;
    transition: transform 0.22s cubic-bezier(0.2, 0.8, 0.2, 1), width 0.22s cubic-bezier(0.2, 0.8, 0.2, 1);
    z-index: 0;
  }

  .petitions-item {
    position: relative;
    z-index: 1;
    border: 0;
    background: transparent;
    color: #fff;
    padding: 10px 14px;
    border-radius: 12px;
    cursor: pointer;
    font: 600 13px/1 system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;
    letter-spacing: 0.02em;
    transition: color 0.16s ease;
  }

  .petitions-item.petitions-highlighted,
  .petitions-item.petitions-highlighted.is-active {
    color: #0b7ed6;
  }

  .petitions-item:hover,
  .petitions-item:focus {
    color: #0b7ed6;
  }

  .petitions-item.is-active {
    color: #fff;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('file-preview-modal');
  const content = document.getElementById('file-preview-content');
  const closeBtn = document.getElementById('file-preview-close');
  let currentObjectUrl = null;
  if (!modal || !content || !closeBtn) return;

  const normalizeFileText = (text) => {
    if (text == null) {
      return '';
    }
    return String(text)
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .replace(/\s+/g, ' ')
      .trim()
      .toLowerCase();
  };

  const isMonitoriaBaseName = (text) => {
    const normalized = normalizeFileText(text);
    return (
      normalized.includes('01 - monitoria inicial') ||
      normalized.includes('01 - cobranca judicial')
      || normalized.includes('habilitacao')
      || normalized.includes('habilitação')
    );
  };

  const getRowFileNameText = (row) => {
    if (!row) return '';
    const nameInput = row.querySelector('input[name$="-nome"]');
    if (nameInput && nameInput.value) {
      return nameInput.value;
    }
    const nomeCell = row.querySelector('td.field-nome');
    return nomeCell ? nomeCell.textContent : '';
  };

  // Botões "Baixar Doc Editável" e "Baixar PDF" na aba Arquivos + transformar links em "Visualizar"
  // Converte links de arquivo em botão "Visualizar" (apenas no campo de arquivo)
  (function applyVisualizarButtons() {
    const apply = () => {
      const fileLinks = document.querySelectorAll('#arquivos-group td.field-arquivo a[href], #processoarquivo_set-group td.field-arquivo a[href]');
      fileLinks.forEach(link => {
        if (link.dataset.visualizarApplied === '1') return;
        // não mexe no botão de adicionar novo arquivo
        if (link.closest('.add-row')) return;
        link.textContent = 'Visualizar';
        link.classList.add('button');
        link.style.backgroundColor = '#555';
        link.style.color = '#fff';
        link.style.padding = '3px 7px';
        link.style.fontSize = '0.85em';
        link.style.display = 'inline-block';
        link.style.marginTop = '4px';
        link.dataset.visualizarApplied = '1';
      });

      // Remove o prefixo "Atualmente:" / "Currently:" do widget de upload
      document.querySelectorAll('#arquivos-group p.file-upload, #processoarquivo_set-group p.file-upload').forEach(p => {
        const txtNode = Array.from(p.childNodes).find(n => n.nodeType === Node.TEXT_NODE && n.textContent.trim().match(/Atualmente:|Currently:/i));
        if (txtNode) {
          txtNode.textContent = '';
        }
      });
    };
    apply();
    const observer = new MutationObserver(apply);
    observer.observe(document.body, { childList: true, subtree: true });
  })();

  function closeModal() {
    modal.style.display = 'none';
    content.innerHTML = '';
    if (currentObjectUrl) {
      URL.revokeObjectURL(currentObjectUrl);
      currentObjectUrl = null;
    }
  }

  closeBtn.addEventListener('click', closeModal);
  modal.addEventListener('click', function(e) {
    if (e.target === modal) closeModal();
  });

  // Função para escapar HTML e prevenir XSS
  function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function renderFile(href, fileName, arquivoId) {
    if (!href) return;
    // Suporta URLs com query params (S3 assinadas): arquivo.pdf?X-Amz-...
    const urlPath = href.split('?')[0];
    const isImage = /\.(png|jpe?g|gif|webp|bmp)$/i.test(urlPath);
    const isPdf = /\.pdf$/i.test(urlPath);
    if (!isImage && !isPdf) return;

    const displayName = fileName || urlPath.split('/').pop() || 'Documento';
    const safeDisplayName = escapeHtml(displayName);

    if (currentObjectUrl) {
      URL.revokeObjectURL(currentObjectUrl);
      currentObjectUrl = null;
    }

    if (isImage) {
      content.innerHTML = `
        <div style="display:flex; flex-direction:column; gap:12px; align-items:center;">
          <h3 style="margin:0; color:#333; font-size:1rem;">${safeDisplayName}</h3>
          <img src="${href}" alt="Pré-visualização" style="max-width:100%; max-height:75vh; display:block;">
        </div>`;
      modal.style.display = 'flex';
      return;
    }

    // Para PDF, usa proxy do Django e PDF.js para renderizar
    if (!arquivoId) {
      // Sem arquivoId, abre em nova aba
      window.open(href, '_blank');
      return;
    }

    const proxyUrl = `/contratos/arquivo/${arquivoId}/view/`;

    // Mostra loading
    content.innerHTML = `<p style="color:#555; text-align:center;">Carregando PDF...</p>`;
    modal.style.display = 'flex';

    // Usa PDF.js para renderizar
    if (typeof pdfjsLib === 'undefined') {
      console.error('PDF.js não carregado');
      window.open(href, '_blank');
      closeModal();
      return;
    }

    // Carrega o PDF via proxy
    const loadingTask = pdfjsLib.getDocument(proxyUrl);
    loadingTask.promise.then(function(pdf) {
      console.log('PDF carregado, páginas:', pdf.numPages);

      // Cria container com scroll para múltiplas páginas
      content.innerHTML = `
        <div style="display:flex; flex-direction:column; gap:12px; align-items:center; width:85vw; max-width:1000px;">
          <h3 style="margin:0; color:#333; font-size:1rem;">${safeDisplayName}</h3>
          <div id="pdf-container" style="width:100%; height:80vh; overflow-y:auto; background:#525659; padding:10px; border-radius:4px;"></div>
        </div>`;

      const container = document.getElementById('pdf-container');
      const scale = 1.5;

      // Renderiza todas as páginas
      for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
        pdf.getPage(pageNum).then(function(page) {
          const viewport = page.getViewport({ scale: scale });

          const canvas = document.createElement('canvas');
          canvas.style.display = 'block';
          canvas.style.margin = '0 auto 10px auto';
          canvas.style.boxShadow = '0 2px 8px rgba(0,0,0,0.3)';
          canvas.width = viewport.width;
          canvas.height = viewport.height;

          container.appendChild(canvas);

          const context = canvas.getContext('2d');
          page.render({
            canvasContext: context,
            viewport: viewport
          });
        });
      }
    }).catch(function(err) {
      console.error('Erro ao carregar PDF com PDF.js:', err);
      content.innerHTML = `
        <div style="display:flex; flex-direction:column; gap:12px; align-items:center;">
          <p style="color:#c00;">Não foi possível carregar o PDF.</p>
          <p style="color:#666;">${safeDisplayName}</p>
          <a href="${href}" target="_blank" class="button" style="background:#417690; color:#fff; padding:8px 16px;">Abrir em nova aba</a>
        </div>`;
    });
  }

  function renderDocx(href, fileName, arquivoId) {
    if (!href) return;
    const urlPath = href.split('?')[0];
    const displayName = fileName || urlPath.split('/').pop() || 'Documento';
    const safeDisplayName = escapeHtml(displayName);

    content.innerHTML = `<p style="color:#555; text-align:center;">Carregando documento...</p>`;
    modal.style.display = 'flex';

    // Usa proxy do Django para evitar CORS do S3
    const fetchUrl = arquivoId ? `/contratos/arquivo/${arquivoId}/view/` : href;

    fetch(fetchUrl)
      .then(res => {
        if (!res.ok) throw new Error('Falha ao carregar DOCX');
        return res.arrayBuffer();
      })
      .then(arrayBuffer => {
        return mammoth.convertToHtml({ arrayBuffer: arrayBuffer });
      })
      .then(result => {
        content.innerHTML = `
          <div style="width:85vw; max-width:1200px; max-height:85vh; overflow:auto; background:#fff; padding:20px; border-radius:8px;">
            <h3 style="margin:0 0 15px 0; color:#333; font-size:1rem; border-bottom:1px solid #eee; padding-bottom:10px;">${safeDisplayName}</h3>
            <style>
              .docx-preview { font-family: 'Times New Roman', serif; font-size: 12pt; line-height: 1.5; color: #000; }
              .docx-preview p { margin: 0 0 10px 0; }
              .docx-preview table { border-collapse: collapse; width: 100%; margin: 10px 0; }
              .docx-preview td, .docx-preview th { border: 1px solid #ccc; padding: 8px; }
              .docx-preview img { max-width: 100%; height: auto; }
            </style>
            <div class="docx-preview">${result.value}</div>
          </div>`;
      })
      .catch(err => {
        console.error('Erro ao renderizar DOCX:', err);
        content.innerHTML = `
          <div style="display:flex; flex-direction:column; gap:12px; align-items:center; justify-content:center;">
            <p style="color:#c00;">Não foi possível pré-visualizar o documento DOCX.</p>
            <p style="color:#666; font-size:0.9rem;">${safeDisplayName}</p>
            <a href="${href}" target="_blank" class="button" style="background:#417690; color:#fff; padding:8px 16px;">Baixar arquivo</a>
          </div>`;
      });
  }

  function showZipPreview(href, label) {
    if (!href) return;
    const fileName = label || href.split('/').pop() || 'arquivo.zip';
    const safeName = escapeHtml(fileName);
    content.innerHTML = `
      <div style="max-width:480px; text-align:left; display:flex; flex-direction:column; gap:12px;">
        <h3 style="margin:0 0 6px;font-size:1.1rem;">Pré-visualização do ZIP</h3>
        <p style="margin:0; color:#333;">Arquivo: <strong>${safeName}</strong></p>
        <p style="margin:0; color:#555;">Use o botão abaixo para baixar o pacote finalizado.</p>
        <a href="${href}" target="_blank" rel="noopener" class="button" style="background:#1c7ed6; border-color:#1660af; padding:6px 12px; font-weight:600;">Baixar ZIP</a>
      </div>`;
    modal.style.display = 'flex';
  }

  document.body.addEventListener('click', function(e) {
    const link = e.target.closest('a');
    if (!link) return;
    const href = link.getAttribute('href') || '';
    // Apenas links de arquivo da pasta do processo (suporta local /media/ e S3)
    if (!/\/media\/processos\//.test(href) && !/processos\/[\d]+\/pasta\//.test(href) && !/s3\..*\.amazonaws\.com.*processos\//.test(href) && !/documentos_modelo\//.test(href)) return;
    // Extensões suportadas (imagens, PDFs; DOCX tenta abrir o PDF-irmão, senão alerta)
    // Suporta URLs com query params (S3 assinadas): arquivo.pdf?X-Amz-...
    const urlPath = href.split('?')[0];
    const isImage = /\.(png|jpe?g|gif|webp|bmp)$/i.test(urlPath);
    const isPdf = /\.pdf$/i.test(urlPath);
    const isDocx = /\.docx$/i.test(urlPath);
    const isZip = /\.zip$/i.test(urlPath);
    if (!isImage && !isPdf && !isDocx && !isZip) return;

    // Obtém o nome do arquivo do data attribute ou da linha da tabela
    const fileName = link.dataset.fileName || (link.closest('tr') ? getRowFileNameText(link.closest('tr')) : null) || urlPath.split('/').pop();
    // Obtém o ID do arquivo para usar o proxy
    const arquivoId = link.dataset.arquivoId || null;

    if (isDocx) {
      e.preventDefault();
      renderDocx(href, fileName, arquivoId);
      return;
    }

    if (isZip) {
      const wantsPreview = link.dataset.zipPreview === '1';
      if (wantsPreview) {
        e.preventDefault();
        showZipPreview(href, fileName);
        return;
      }
      return;
    }

    if (isImage || isPdf) {
      e.preventDefault();
      console.log('renderFile chamado com:', { href, fileName, arquivoId });
      renderFile(href, fileName, arquivoId);
    }
  }, true);

  // Insere botões de Visualizar / PDF / DOC nos arquivos do tipo Monitória/Cobrança e Visualizar/Baixar nos demais
  ;(function injectDownloadButtons() {
    const arquivosGroup = document.querySelector('#arquivos-group') || document.querySelector('#processoarquivo_set-group');
    if (!arquivosGroup) return;

      const createButton = (text, href, opts = {}) => {
        const btn = document.createElement('a');
        btn.href = href;
        btn.textContent = text;
        btn.className = 'button';
        btn.style.padding = '4px 7px';
        btn.style.background = '#555';
        btn.style.color = '#fff';
        btn.style.border = '1px solid #444';
        btn.style.boxShadow = 'none';
        btn.style.fontWeight = '400';
        btn.style.fontSize = '0.85em';
        if (opts.preview) {
          btn.dataset.zipPreview = '1';
        }
        if (opts.download) {
          btn.setAttribute('download', '');
        }
        const openInNewTab = Boolean(opts.openInNewTab);
        if (opts.download || openInNewTab) {
        btn.addEventListener('click', function(ev) {
          ev.preventDefault();
          window.open(href, '_blank');
        });
      }
      return btn;
    };

    const isMonitoriaRow = (row) => {
      const text = getRowFileNameText(row);
      return isMonitoriaBaseName(text);
    };

    const createBaseBadge = (baseCheckbox) => {
      const wrapper = document.createElement('label');
      wrapper.className = 'monitoria-checkbox-wrapper';
      const label = document.createElement('span');
      label.textContent = 'Base';
      wrapper.appendChild(label);
      const syncWrapper = () => {
        const checked = Boolean(baseCheckbox.checked);
        wrapper.classList.toggle('checked', checked);
        label.classList.toggle('base-active', checked);
      };
      baseCheckbox.addEventListener('change', syncWrapper);
      syncWrapper();
      return wrapper;
    };

    const attachBaseBadge = (row, btnRow, attempt = 0) => {
      if (!row || row.dataset.monitoriaBadgeAdded === '1' || attempt > 10) {
        return;
      }
      const baseCheckbox = row.querySelector('.arquivos-peticoes-base-checkbox');
      if (!baseCheckbox) {
        setTimeout(() => {
          attachBaseBadge(row, btnRow, attempt + 1);
        }, 80);
        return;
      }
      const badge = createBaseBadge(baseCheckbox);
      btnRow.appendChild(badge);
      row.dataset.monitoriaBadgeAdded = '1';
    };

    const getUploaderName = (row) => {
      const cell = row.querySelector('td.field-enviado_por');
      if (!cell) {
        return '';
      }
      const input = cell.querySelector('input[type="text"]');
      if (input && input.value.trim()) {
        return input.value.trim();
      }
      const select = cell.querySelector('select');
      if (select) {
        const selected = select.selectedOptions[0];
        if (selected && selected.textContent.trim()) {
          return selected.textContent.trim();
        }
      }
      const linkText = cell.querySelector('a');
      if (linkText && linkText.textContent.trim()) {
        return linkText.textContent.trim();
      }
      const raw = cell.textContent || '';
      return raw.trim();
    };

    const getCreationDate = (row) => {
      const cell = row.querySelector('td.field-criado_em');
      if (!cell) {
        return '';
      }
      const raw = cell.textContent || '';
      return raw.trim().replace(/\s+/g, ' ');
    };

    const renderUploaderLine = (row, nomeCell) => {
      if (!row || !nomeCell) {
        return;
      }
      let uploaderLine = row.querySelector('.documento-peticoes-uploader-line');
      if (!uploaderLine) {
        uploaderLine = document.createElement('div');
        uploaderLine.className = 'documento-peticoes-uploader-line';
        nomeCell.appendChild(uploaderLine);
      }
      const name = getUploaderName(row);
      const dateText = getCreationDate(row);
      if (!name && !dateText) {
        uploaderLine.style.display = 'none';
        return;
      }
      let text = 'Enviado';
      if (name) {
        text += ` por ${name}`;
      }
      if (dateText) {
        text += name ? ` em ${dateText}` : ` em ${dateText}`;
      }
      uploaderLine.textContent = text;
      uploaderLine.style.display = 'block';
    };

    const setupModifyControl = (row, arquivoCell, hasFileLink = false) => {
      if (!row || row.dataset.modifyControlAdded === '1' || !arquivoCell) {
        return;
      }
      const fileUpload = arquivoCell.querySelector('p.file-upload');
      const fileInput = arquivoCell.querySelector('input[type="file"]');
      const nomeCell = row.querySelector('td.field-nome');
      if (!nomeCell) {
        return;
      }
      if (!fileInput) {
        return;
      }
      if (fileUpload) {
        Array.from(fileUpload.childNodes).forEach(node => {
          if (node.nodeType === Node.TEXT_NODE) {
            node.textContent = '';
          }
        });
      }

      // Cria controle de enviar/alterar arquivo
      const modifyRow = document.createElement('div');
      modifyRow.className = 'documento-peticoes-modify-row';
      const label = document.createElement('span');
      label.textContent = hasFileLink ? 'Alterar:' : 'Enviar:';
      label.style.fontWeight = '600';
      const button = document.createElement('button');
      button.type = 'button';
      button.className = 'button button-secondary';
      button.textContent = hasFileLink ? 'Escolher novo arquivo...' : 'Escolher arquivo...';

      // Span para mostrar nome do arquivo selecionado
      const selectedFileName = document.createElement('span');
      selectedFileName.className = 'selected-file-name';
      selectedFileName.style.marginLeft = '8px';
      selectedFileName.style.color = '#417690';
      selectedFileName.style.fontStyle = 'italic';

      button.addEventListener('click', (event) => {
        event.preventDefault();
        fileInput.click();
      });

      // Listener para quando arquivo é selecionado
      fileInput.addEventListener('change', () => {
        if (fileInput.files && fileInput.files.length > 0) {
          const newFileName = fileInput.files[0].name;
          selectedFileName.textContent = newFileName;
          // Atualiza o label para indicar que tem alteração pendente
          label.textContent = 'Novo arquivo:';
          label.style.color = '#e67e22';
        } else {
          selectedFileName.textContent = '';
          label.textContent = hasFileLink ? 'Alterar:' : 'Enviar:';
          label.style.color = '';
        }
      });

      modifyRow.appendChild(label);
      modifyRow.appendChild(button);
      modifyRow.appendChild(selectedFileName);

      // Se tem arquivo no S3, só mostra opção de alterar (não obrigatório)
      // Se não tem arquivo, mostra para enviar
      nomeCell.appendChild(modifyRow)

      renderUploaderLine(row, nomeCell);
      if (fileUpload) {
        fileUpload.style.display = 'none';
      }
      row.dataset.modifyControlAdded = '1';
    };

    const createConfirmOverlay = (message) => {
      let overlay = document.getElementById('arquivo-delete-confirm-overlay');
      if (overlay) {
        overlay.remove();
      }
      overlay = document.createElement('div');
      overlay.id = 'arquivo-delete-confirm-overlay';
      overlay.style.position = 'fixed';
      overlay.style.inset = '0';
      overlay.style.backgroundColor = 'rgba(0,0,0,0.4)';
      overlay.style.display = 'flex';
      overlay.style.alignItems = 'center';
      overlay.style.justifyContent = 'center';
      overlay.style.zIndex = '10001';
      const card = document.createElement('div');
      card.style.background = '#fff';
      card.style.padding = '20px';
      card.style.borderRadius = '10px';
      card.style.maxWidth = '320px';
      card.style.textAlign = 'center';
      card.style.boxShadow = '0 12px 30px rgba(0,0,0,0.3)';
      const label = document.createElement('p');
      label.textContent = message;
      label.style.marginBottom = '20px';
      card.appendChild(label);
      const actions = document.createElement('div');
      actions.style.display = 'flex';
      actions.style.justifyContent = 'center';
      actions.style.gap = '12px';
      const btnSim = document.createElement('button');
      btnSim.type = 'button';
      btnSim.textContent = 'Sim';
      btnSim.className = 'button button-primary';
      const btnCancelar = document.createElement('button');
      btnCancelar.type = 'button';
      btnCancelar.textContent = 'Cancelar';
      btnCancelar.className = 'button button-secondary';
      actions.appendChild(btnCancelar);
      actions.appendChild(btnSim);
      card.appendChild(actions);
      overlay.appendChild(card);
      document.body.appendChild(overlay);
      return { overlay, btnSim, btnCancelar };
    };

    const appendRemoveButton = (row, container) => {
      if (!row || !container || row.dataset.removeBtnAdded === '1') {
        return;
      }
      const deleteCheckbox = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
      if (!deleteCheckbox) {
        return;
      }
      deleteCheckbox.style.display = 'none';
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'button';
      btn.textContent = '×';
      btn.title = 'Remover arquivo';
      btn.style.backgroundColor = '#d63636';
      btn.style.color = '#fff';
      btn.style.borderRadius = '999px';
      btn.style.width = '20px';
      btn.style.height = '20px';
      btn.style.border = 'none';
      btn.style.display = 'flex';
      btn.style.alignItems = 'center';
      btn.style.justifyContent = 'center';
      btn.style.fontSize = '1.1rem';
      btn.style.cursor = 'pointer';
      const nomeCell = row.querySelector('td.field-nome');
      const fileName = (row.querySelector('input[name$="-nome"]')?.value || nomeCell?.textContent || 'arquivo').trim();
      btn.addEventListener('click', (event) => {
        event.preventDefault();
        const { overlay, btnSim, btnCancelar } = createConfirmOverlay(`Confirmar deletar o arquivo "${fileName}"?`);
        const cleanUp = () => {
          overlay.remove();
          btnSim.removeEventListener('click', simHandler);
          btnCancelar.removeEventListener('click', cancelHandler);
        };
        const simHandler = () => {
          deleteCheckbox.checked = true;
          row.style.display = 'none';
          cleanUp();
        };
        const cancelHandler = () => {
          cleanUp();
        };
        btnSim.addEventListener('click', simHandler);
        btnCancelar.addEventListener('click', cancelHandler);
      });
      container.appendChild(btn);
      row.dataset.removeBtnAdded = '1';
    };

    const processRow = (row) => {
      if (row.dataset.downloadButtonsInjected === '1') {
        return;
      }
      const arquivoCell = row.querySelector('td.field-arquivo');
      if (!arquivoCell) {
        return;
      }
      const link = arquivoCell.querySelector('a[href*="/media/"], a[href*="processos/"], a[href*="s3."], a[href*="amazonaws.com"]');
      setupModifyControl(row, arquivoCell, Boolean(link));
      if (!link) {
        return;
      }
      link.style.display = 'none';

      const actionBar = document.createElement('div');
      actionBar.className = 'documento-peticoes-action-bar';
      actionBar.style.display = 'flex';
      actionBar.style.justifyContent = 'flex-end';
      actionBar.style.gap = '6px';
      actionBar.style.marginBottom = '6px';

      const btnRow = document.createElement('div');
      btnRow.className = 'documento-peticoes-download-row';
      btnRow.style.display = 'flex';
      btnRow.style.flexWrap = 'nowrap';
      btnRow.style.gap = '6px';
      btnRow.style.margin = '6px 0 4px 0';
      btnRow.style.alignItems = 'center';
      btnRow.style.width = '100%';
      btnRow.style.justifyContent = 'space-between';

      const leftGroup = document.createElement('div');
      leftGroup.style.display = 'flex';
      leftGroup.style.flexWrap = 'wrap';
      leftGroup.style.gap = '6px';
      const isProtocolRowEntry = isProtocolRow(row);
      const linkPath = link.href.split('?')[0];
      const isZipFile = /\.zip$/i.test(linkPath);
      const visualizarOpts = isProtocolRowEntry && isZipFile ? { preview: true } : {};

      // Obtém o nome do arquivo para exibir no modal
      const fileName = getRowFileNameText(row) || linkPath.split('/').pop() || 'Documento';

      // Detecta a extensão real do arquivo
      const isPdfFile = /\.pdf$/i.test(linkPath);
      const isDocxFile = /\.docx$/i.test(linkPath);

      // Cria URLs para PDF e DOCX baseadas no link original
      const baseUrl = linkPath.replace(/\.(pdf|docx)$/i, '');
      const queryParams = link.href.includes('?') ? link.href.substring(link.href.indexOf('?')) : '';
      const pdfUrl = baseUrl + '.pdf' + queryParams;
      const docxUrl = baseUrl + '.docx' + queryParams;

      // Tenta obter o ID do arquivo do inline form
      const getArquivoId = () => {
        // Busca qualquer input cujo name termine com -id e tenha valor numérico
        const allInputs = row.querySelectorAll('input');
        for (const inp of allInputs) {
          const name = inp.name || '';
          const value = inp.value || '';
          // Padrão: arquivos-0-id, processoarquivo_set-0-id, etc.
          if (name.endsWith('-id') && /^\d+$/.test(value)) {
            return value;
          }
        }
        // Fallback: data attribute
        if (row.dataset.arquivoId) {
          return row.dataset.arquivoId;
        }
        return null;
      };
      const arquivoId = getArquivoId();

      // Botão Visualizar - identifica o tipo e exibe corretamente
      const visualizarBtn = createButton('Visualizar', link.href, visualizarOpts);
      visualizarBtn.dataset.fileName = fileName;
      visualizarBtn.dataset.fileType = isPdfFile ? 'pdf' : (isDocxFile ? 'docx' : 'other');
      if (arquivoId) {
        visualizarBtn.dataset.arquivoId = arquivoId;
      }
      leftGroup.appendChild(visualizarBtn);

      // SEMPRE mostra ambos os botões (PDF e DOC) para todos os arquivos
      // Se o formato não existe, converte on-demand
      if (isPdfFile || isDocxFile) {
        // Container para os botões PDF e DOC (mantém ordem: PDF, DOC)
        const formatBtnsContainer = document.createElement('span');
        formatBtnsContainer.className = 'format-buttons-container';
        formatBtnsContainer.style.display = 'inline-flex';
        formatBtnsContainer.style.gap = '6px';

        // URLs para conversão via backend
        const convertToPdfUrl = arquivoId ? `/contratos/arquivo/${arquivoId}/convert-to-pdf/` : null;
        const convertToDocxUrl = arquivoId ? `/contratos/arquivo/${arquivoId}/convert-to-docx/` : null;

        // Botão PDF - sempre disponível
        const pdfBtn = document.createElement('a');
        pdfBtn.textContent = 'PDF';
        pdfBtn.className = 'button';
        pdfBtn.style.padding = '4px 7px';
        pdfBtn.style.background = '#555';
        pdfBtn.style.color = '#fff';
        pdfBtn.style.border = '1px solid #444';
        pdfBtn.style.boxShadow = 'none';
        pdfBtn.style.fontWeight = '400';
        pdfBtn.style.fontSize = '0.85em';
        pdfBtn.style.cursor = 'pointer';
        pdfBtn.dataset.formatType = 'pdf';

        if (isPdfFile) {
          // Arquivo já é PDF, baixa direto via proxy
          pdfBtn.href = '#';
          pdfBtn.addEventListener('click', (ev) => {
            ev.preventDefault();
            // Usa o convert-to-pdf que retorna o PDF direto se já for PDF
            if (convertToPdfUrl) {
              window.location.href = convertToPdfUrl;
            } else {
              window.open(pdfUrl, '_blank');
            }
          });
        } else if (isDocxFile) {
          // Arquivo é DOCX, converte para PDF
          pdfBtn.href = '#';
          pdfBtn.addEventListener('click', (ev) => {
            ev.preventDefault();
            if (!convertToPdfUrl) {
              alert('Não foi possível converter. ID do arquivo não encontrado.');
              return;
            }
            pdfBtn.textContent = 'Convertendo...';
            pdfBtn.style.pointerEvents = 'none';
            // Abre a URL de conversão que faz download do PDF
            window.location.href = convertToPdfUrl;
            setTimeout(() => {
              pdfBtn.textContent = 'PDF';
              pdfBtn.style.pointerEvents = 'auto';
            }, 2000);
          });
        }
        formatBtnsContainer.appendChild(pdfBtn);

        // Botão DOC - sempre disponível
        const docBtn = document.createElement('a');
        docBtn.textContent = 'DOC';
        docBtn.className = 'button';
        docBtn.style.padding = '4px 7px';
        docBtn.style.background = '#555';
        docBtn.style.color = '#fff';
        docBtn.style.border = '1px solid #444';
        docBtn.style.boxShadow = 'none';
        docBtn.style.fontWeight = '400';
        docBtn.style.fontSize = '0.85em';
        docBtn.style.cursor = 'pointer';
        docBtn.dataset.formatType = 'docx';

        if (isDocxFile) {
          // Arquivo já é DOCX, baixa direto via proxy
          docBtn.href = '#';
          docBtn.addEventListener('click', (ev) => {
            ev.preventDefault();
            // Usa o convert-to-docx que retorna o DOCX direto se já for DOCX
            if (convertToDocxUrl) {
              window.location.href = convertToDocxUrl;
            } else {
              window.open(docxUrl, '_blank');
            }
          });
        } else if (isPdfFile) {
          // Arquivo é PDF, converte para DOCX
          docBtn.href = '#';
          docBtn.addEventListener('click', (ev) => {
            ev.preventDefault();
            if (!convertToDocxUrl) {
              alert('Não foi possível converter. ID do arquivo não encontrado.');
              return;
            }
            docBtn.textContent = 'Convertendo...';
            docBtn.style.pointerEvents = 'none';
            // Abre a URL de conversão que faz download do DOCX
            window.location.href = convertToDocxUrl;
            setTimeout(() => {
              docBtn.textContent = 'DOC';
              docBtn.style.pointerEvents = 'auto';
            }, 2000);
          });
        }
        formatBtnsContainer.appendChild(docBtn);

        leftGroup.appendChild(formatBtnsContainer);

        // Badge "Base" apenas para arquivos de Monitória
        if (isMonitoriaRow(row)) {
          attachBaseBadge(row, leftGroup);
        }
      }

      const rightGroup = document.createElement('div');
      rightGroup.style.display = 'flex';
      rightGroup.style.alignItems = 'center';

      btnRow.appendChild(leftGroup);
      btnRow.appendChild(rightGroup);

      const nomeCell = row.querySelector('td.field-nome');
      if (nomeCell) {
        nomeCell.appendChild(actionBar);
        nomeCell.appendChild(btnRow);
      } else {
        row.appendChild(actionBar);
        row.appendChild(btnRow);
      }

      appendRemoveButton(row, actionBar);

      const shouldShowToggle =
        (isProtocolRowEntry || isHabilitacaoRow(row)) && !row.dataset.protocolToggleAdded;
      const protocolCheckbox = row.querySelector('input[type="checkbox"][name$="-protocolado_no_tribunal"]');
      if (shouldShowToggle && protocolCheckbox) {
        const toggle = createProtocolToggle(protocolCheckbox);
        if (toggle) {
          rightGroup.appendChild(toggle);
          row.dataset.protocolToggleAdded = '1';
        }
      }
      row.dataset.downloadButtonsInjected = '1';
    };

    const normalizeNameForProtocol = (text) => {
      if (!text) {
        return '';
      }
      return text
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/\s+/g, ' ')
        .trim()
        .toLowerCase();
    };
    const isProtocolRow = (row) => {
      if (!row) return false;
      const name = getRowFileNameText(row);
      if (!name) return false;
      return normalizeNameForProtocol(name).includes('protocolo');
    };
    const isHabilitacaoRow = (row) => {
      if (!row) return false;
      const name = getRowFileNameText(row);
      return name && normalizeNameForProtocol(name).includes('habilitacao');
    };

    const createProtocolToggle = (checkbox) => {
      if (!checkbox) {
        return null;
      }
      checkbox.style.display = 'none';
      checkbox.dataset.protocolToggleManaged = '1';
      const wrapper = document.createElement('label');
      wrapper.className = 'protocol-toggle';
      wrapper.title = 'Ative ao confirmar o protocolo no tribunal';
      wrapper.setAttribute('aria-pressed', 'false');
      const switchEl = document.createElement('span');
      switchEl.className = 'supervision-switch';
      const labelText = document.createElement('span');
      labelText.className = 'supervision-label-text';
      labelText.textContent = 'Confirma Protocolo no Tribunal';
      wrapper.appendChild(switchEl);
      wrapper.appendChild(labelText);

      const updateState = () => {
        const checked = Boolean(checkbox.checked);
        wrapper.classList.toggle('protocol-toggle--active', checked);
        wrapper.classList.toggle('protocol-toggle--inactive', !checked);
        wrapper.setAttribute('aria-pressed', checked ? 'true' : 'false');
      };

      const toggleState = (event) => {
        event.preventDefault();
        checkbox.checked = !checkbox.checked;
        checkbox.dispatchEvent(new Event('change', { bubbles: true }));
        updateState();
        setTimeout(() => {
          clickSaveAndContinueEditor();
        }, 150);
      };

      wrapper.addEventListener('click', toggleState);
      checkbox.addEventListener('change', updateState);
      updateState();
      return wrapper;
    };

    const tryInsert = () => {
      const rows = arquivosGroup.querySelectorAll('tr.dynamic-processoarquivo, tr.dynamic-arquivos');
      rows.forEach(processRow);
    };

    tryInsert();
    const observer = new MutationObserver(tryInsert);
    observer.observe(arquivosGroup, { childList: true, subtree: true });
  })();


  // Substitui o checkbox de remoção por botão “×” vermelho com confirmação customizada
  (function enhanceArquivoInlineDeletes() {
    const inlineGroup = document.querySelector('#processoarquivo_set-group');
    if (!inlineGroup) return;

    const createConfirmOverlay = (message) => {
      let overlay = document.getElementById('arquivo-delete-confirm-overlay');
      if (overlay) {
        overlay.remove();
      }
      overlay = document.createElement('div');
      overlay.id = 'arquivo-delete-confirm-overlay';
      overlay.style.position = 'fixed';
      overlay.style.inset = '0';
      overlay.style.backgroundColor = 'rgba(0,0,0,0.4)';
      overlay.style.display = 'flex';
      overlay.style.alignItems = 'center';
      overlay.style.justifyContent = 'center';
      overlay.style.zIndex = '10001';
      const card = document.createElement('div');
      card.style.background = '#fff';
      card.style.padding = '20px';
      card.style.borderRadius = '10px';
      card.style.maxWidth = '320px';
      card.style.textAlign = 'center';
      card.style.boxShadow = '0 12px 30px rgba(0,0,0,0.3)';
      const label = document.createElement('p');
      label.textContent = message;
      label.style.marginBottom = '20px';
      card.appendChild(label);
      const actions = document.createElement('div');
      actions.style.display = 'flex';
      actions.style.justifyContent = 'center';
      actions.style.gap = '12px';
      const btnSim = document.createElement('button');
      btnSim.type = 'button';
      btnSim.textContent = 'Sim';
      btnSim.className = 'button button-primary';
      const btnCancelar = document.createElement('button');
      btnCancelar.type = 'button';
      btnCancelar.textContent = 'Cancelar';
      btnCancelar.className = 'button button-secondary';
      actions.appendChild(btnCancelar);
      actions.appendChild(btnSim);
      card.appendChild(actions);
      overlay.appendChild(card);
      document.body.appendChild(overlay);
      return { overlay, btnSim, btnCancelar };
    };

    const attachRemoveButton = (row) => {
      if (row.dataset.removeBtnAdded) return;
      const deleteCheckbox = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
      if (!deleteCheckbox) return;
      deleteCheckbox.style.display = 'none';
      const nomeCell = row.querySelector('td.field-nome');
      if (!nomeCell) return;
      let wrapper = row.querySelector('.documento-peticoes-remove-wrapper');
      if (!wrapper) {
        wrapper = document.createElement('div');
        wrapper.className = 'documento-peticoes-remove-wrapper';
        nomeCell.appendChild(wrapper);
      }
      wrapper.innerHTML = '';
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'button';
      btn.textContent = '×';
      btn.title = 'Remover arquivo';
      btn.style.backgroundColor = '#d63636';
      btn.style.color = '#fff';
      btn.style.borderRadius = '999px';
      btn.style.width = '28px';
      btn.style.height = '28px';
      btn.style.border = 'none';
      btn.style.fontSize = '1.2rem';
      btn.style.cursor = 'pointer';
      const fileName = (row.querySelector('input[name$="-nome"]')?.value || nomeCell.textContent || 'arquivo').trim();
      btn.addEventListener('click', (event) => {
        event.preventDefault();
        const { overlay, btnSim, btnCancelar } = createConfirmOverlay(`Confirmar deletar o arquivo "${fileName}"?`);
        const cleanUp = () => {
          overlay.remove();
          btnSim.removeEventListener('click', simHandler);
          btnCancelar.removeEventListener('click', cancelHandler);
        };
        const simHandler = () => {
          deleteCheckbox.checked = true;
          row.style.display = 'none';
          cleanUp();
        };
        const cancelHandler = () => {
          cleanUp();
        };
        btnSim.addEventListener('click', simHandler);
        btnCancelar.addEventListener('click', cancelHandler);
      });
      wrapper.appendChild(btn);
      row.dataset.removeBtnAdded = '1';
    };

    const init = () => {
      inlineGroup.querySelectorAll('.dynamic-processoarquivo, .dynamic-arquivos').forEach(attachRemoveButton);
    };

    init();
  })();

  (function hideArquivoHeaders() {
    const selectors = [
      '#arquivos-group thead th',
      '#processoarquivo_set-group thead th'
    ];
    selectors.forEach(selector => {
      document.querySelectorAll(selector).forEach(th => {
        const text = (th.textContent || '').trim().toLowerCase();
        if (!text) return;
        if (text.includes('arquivo') || text.includes('remover')) {
          th.style.display = 'none';
        }
      });
    });
  })();

});
</script>
{% endblock %}
