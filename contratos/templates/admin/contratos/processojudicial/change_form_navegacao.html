{% extends "admin/contratos/processojudicial/change_form_etiquetas.html" %}
{% load i18n static %}

{% block extrahead %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'admin/css/documento_modelo_peticoes.css' %}">
<script>
window.__analise_is_supervisor = {{ is_supervisor|default_if_none:False|yesno:"true,false" }};
window.__tipos_peticao_api_url = "{{ tipos_peticao_api_url|default:'' }}";
window.__tipos_peticao_preview_url = "{{ tipos_peticao_preview_url|default:'' }}";
window.__tipos_peticao_generate_url = "{{ tipos_peticao_generate_url|default:'' }}";
window.__tipos_peticao_csrf_token = "{{ csrf_token|default:'' }}";
</script>
{% endblock %}

{% block content %}
<div class="navigation-buttons" style="text-align: right; margin-bottom: 10px;">
  {% if prev_obj_url %}
    <a href="{{ prev_obj_url }}" class="button" style="font-size: 1.2em; padding: 5px 10px; margin-right: 5px; background: none; border: none; box-shadow: none; color: #417690;"><</a>
  {% else %}
    <span class="button disabled" style="font-size: 1.2em; padding: 5px 10px; margin-right: 5px; background: none; border: none; box-shadow: none; color: #ccc; cursor: default;"> < </span>
  {% endif %}
  
  {% if next_obj_url %}
    <a href="{{ next_obj_url }}" class="button" style="font-size: 1.2em; padding: 5px 10px; background: none; border: none; box-shadow: none; color: #417690;"> > </a>
  {% else %}
    <span class="button disabled" style="font-size: 1.2em; padding: 5px 10px; background: none; border: none; box-shadow: none; color: #ccc; cursor: default;"> > </span>
  {% endif %}
</div>
{{ block.super }} {# Render the content from the parent template #}

<div id="file-preview-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:10000; align-items:center; justify-content:center;">
  <div id="file-preview-content" style="background:#fff; padding:12px; border-radius:6px; max-width:90%; max-height:90%; position:relative; box-shadow:0 8px 24px rgba(0,0,0,0.25);"></div>
  <button id="file-preview-close" style="position:absolute; top:12px; right:16px; background:#444; color:#fff; border:none; padding:6px 10px; border-radius:4px; cursor:pointer;">Fechar</button>
</div>

<style>
#processoarquivo_set-group th.delete,
#processoarquivo_set-group td.delete,
#processoarquivo_set-group th.column-delete,
#processoarquivo_set-group td.column-delete,
#processoarquivo_set-group thead th:last-child,
#processoarquivo_set-group tbody td:last-child {
  display: none !important;
}

.monitoria-checkbox-wrapper {
  display: inline-flex;
  align-items: center;
  margin-left: 10px;
}

.monitoria-checkbox-wrapper input[type="checkbox"] {
  display: none;
}

.monitoria-checkbox-wrapper span {
  font-size: 0.85rem;
  letter-spacing: 0.04em;
  padding: 6px 18px;
  border-radius: 10px;
  border: 1px solid #cbd5e0;
  background: #ffffff;
  color: #42748fff;
  font-weight: 600;
  cursor: pointer;
  box-shadow: inset 0 -1px 0 rgba(0, 0, 0, 0.08);
  transition: background 0.2s ease, color 0.2s ease, border 0.2s ease, transform 0.15s ease;
}

.monitoria-checkbox-wrapper span:focus-visible {
  outline: 2px solid rgba(66, 116, 143, 0.6);
  outline-offset: 2px;
}

.monitoria-checkbox-wrapper input[type="checkbox"]:checked + span,
.monitoria-checkbox-wrapper.checked span {
  border-color: #42748fff;
  background: #42748fff;
  color: #ffffff;
  box-shadow: 0 6px 12px rgba(66, 116, 143, 0.2);
  transform: translateY(-1px);
}

.documento-peticoes-modify-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 6px;
}

.documento-peticoes-modify-row .button {
  padding: 3px 10px;
  font-size: 0.85em;
}
 .documento-peticoes-modify-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 6px;
}

.documento-peticoes-modify-row .button {
  padding: 3px 10px;
  font-size: 0.85em;
}

.documento-peticoes-uploader-line {
  font-size: 0.8rem;
  color: #5f6b7a;
  margin-top: 4px;
  text-transform: capitalize;
}

#arquivos-group th.column-enviado_por,
#processoarquivo_set-group th.column-enviado_por,
#arquivos-group td.field-enviado_por,
#processoarquivo_set-group td.field-enviado_por {
  display: none;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('file-preview-modal');
  const content = document.getElementById('file-preview-content');
  const closeBtn = document.getElementById('file-preview-close');
  let currentObjectUrl = null;
  if (!modal || !content || !closeBtn) return;

  const normalizeFileText = (text) => {
    if (text == null) {
      return '';
    }
    return String(text)
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .replace(/\s+/g, ' ')
      .trim()
      .toLowerCase();
  };

  const isMonitoriaBaseName = (text) => {
    return normalizeFileText(text).includes('01 - monitoria inicial');
  };

  const getRowFileNameText = (row) => {
    if (!row) return '';
    const nameInput = row.querySelector('input[name$="-nome"]');
    if (nameInput && nameInput.value) {
      return nameInput.value;
    }
    const nomeCell = row.querySelector('td.field-nome');
    return nomeCell ? nomeCell.textContent : '';
  };

  // Botões "Baixar Doc Editável" e "Baixar PDF" na aba Arquivos + transformar links em "Visualizar"
  // Converte links de arquivo em botão "Visualizar" (apenas no campo de arquivo)
  (function applyVisualizarButtons() {
    const apply = () => {
      const fileLinks = document.querySelectorAll('#arquivos-group td.field-arquivo a[href], #processoarquivo_set-group td.field-arquivo a[href]');
      fileLinks.forEach(link => {
        if (link.dataset.visualizarApplied === '1') return;
        // não mexe no botão de adicionar novo arquivo
        if (link.closest('.add-row')) return;
        link.textContent = 'Visualizar';
        link.classList.add('button');
        link.style.backgroundColor = '#555';
        link.style.color = '#fff';
        link.style.padding = '3px 7px';
        link.style.fontSize = '0.85em';
        link.style.display = 'inline-block';
        link.style.marginTop = '4px';
        link.dataset.visualizarApplied = '1';
      });

      // Remove o prefixo "Atualmente:" / "Currently:" do widget de upload
      document.querySelectorAll('#arquivos-group p.file-upload, #processoarquivo_set-group p.file-upload').forEach(p => {
        const txtNode = Array.from(p.childNodes).find(n => n.nodeType === Node.TEXT_NODE && n.textContent.trim().match(/Atualmente:|Currently:/i));
        if (txtNode) {
          txtNode.textContent = '';
        }
      });
    };
    apply();
    const observer = new MutationObserver(apply);
    observer.observe(document.body, { childList: true, subtree: true });
  })();

  function closeModal() {
    modal.style.display = 'none';
    content.innerHTML = '';
    if (currentObjectUrl) {
      URL.revokeObjectURL(currentObjectUrl);
      currentObjectUrl = null;
    }
  }

  closeBtn.addEventListener('click', closeModal);
  modal.addEventListener('click', function(e) {
    if (e.target === modal) closeModal();
  });

  function renderFile(href) {
    if (!href) return;
    const isImage = /\.(png|jpe?g|gif|webp|bmp)$/i.test(href);
    const isPdf = /\.pdf$/i.test(href);
    if (!isImage && !isPdf) return;

    if (currentObjectUrl) {
      URL.revokeObjectURL(currentObjectUrl);
      currentObjectUrl = null;
    }

    if (isImage) {
      content.innerHTML = `<img src="${href}" alt="Pré-visualização" style="max-width:100%; max-height:80vh; display:block; margin:0 auto;">`;
      modal.style.display = 'flex';
      return;
    }

    content.innerHTML = `<p style="color:#555; text-align:center;">Carregando PDF...</p>`;
    fetch(href).then(res => {
      if (!res.ok) throw new Error('Falha ao carregar PDF');
      return res.blob();
    }).then(blob => {
      currentObjectUrl = URL.createObjectURL(blob);
      content.innerHTML = `
        <div style="display:flex; flex-direction:column; gap:12px; align-items:center; justify-content:center;">
          <iframe src="${currentObjectUrl}" title="Pré-visualização PDF" style="width:80vw; height:80vh; border:none;" loading="lazy"></iframe>
        </div>`;
    }).catch(() => {
      content.innerHTML = `
        <div style="display:flex; flex-direction:column; gap:12px; align-items:center; justify-content:center;">
          <p style="color:#c00;">Não foi possível pré-visualizar o PDF.</p>
        </div>`;
    });
    modal.style.display = 'flex';
  }

  document.body.addEventListener('click', function(e) {
    const link = e.target.closest('a');
    if (!link) return;
    const href = link.getAttribute('href') || '';
    // Apenas links de arquivo da pasta do processo
    if (!/\/media\/processos\//.test(href) && !/processos\/[\d]+\/pasta\//.test(href)) return;
    // Extensões suportadas (imagens, PDFs; DOCX tenta abrir o PDF-irmão, senão alerta)
    const isImage = /\.(png|jpe?g|gif|webp|bmp)$/i.test(href);
    const isPdf = /\.pdf$/i.test(href);
    const isDocx = /\.docx$/i.test(href);
    if (!isImage && !isPdf && !isDocx) return;
    e.preventDefault();

    if (isDocx) {
      const pdfHref = href.replace(/\.docx$/i, '.pdf');
      fetch(pdfHref, { method: 'HEAD' })
        .then(res => {
          if (res.ok) {
            renderFile(pdfHref);
          } else {
            alert('Pré-visualização disponível apenas em PDF. Gere/aguarde o PDF na aba Arquivos.');
          }
        })
        .catch(() => {
          alert('Pré-visualização disponível apenas em PDF. Gere/aguarde o PDF na aba Arquivos.');
        });
      return;
    }

    renderFile(href);
  }, true);

  // Insere botões de Visualizar / PDF / DOC nos arquivos do tipo Monitória/Cobrança e Visualizar/Baixar nos demais
  ;(function injectDownloadButtons() {
    const arquivosGroup = document.querySelector('#arquivos-group') || document.querySelector('#processoarquivo_set-group');
    if (!arquivosGroup) return;

    const createButton = (text, href, opts = {}) => {
      const btn = document.createElement('a');
      btn.href = href;
      btn.textContent = text;
      btn.className = 'button';
      btn.style.padding = '4px 7px';
      btn.style.background = '#555';
      btn.style.color = '#fff';
      btn.style.border = '1px solid #444';
      btn.style.boxShadow = 'none';
      btn.style.fontWeight = '400';
      btn.style.fontSize = '0.85em';
      if (opts.download) {
        btn.setAttribute('download', '');
      }
      btn.addEventListener('click', function(ev) {
        ev.preventDefault();
        window.open(href, '_blank');
      });
      return btn;
    };

    const isMonitoriaRow = (row) => {
      const text = getRowFileNameText(row);
      return isMonitoriaBaseName(text);
    };

    const createBaseBadge = (baseCheckbox) => {
      const wrapper = document.createElement('label');
      wrapper.className = 'monitoria-checkbox-wrapper';
      const label = document.createElement('span');
      label.textContent = 'Base';
      wrapper.appendChild(label);
      const syncWrapper = () => {
        const checked = Boolean(baseCheckbox.checked);
        wrapper.classList.toggle('checked', checked);
        label.classList.toggle('base-active', checked);
      };
      baseCheckbox.addEventListener('change', syncWrapper);
      syncWrapper();
      return wrapper;
    };

    const attachBaseBadge = (row, btnRow, attempt = 0) => {
      if (!row || row.dataset.monitoriaBadgeAdded === '1' || attempt > 10) {
        return;
      }
      const baseCheckbox = row.querySelector('.arquivos-peticoes-base-checkbox');
      if (!baseCheckbox) {
        setTimeout(() => {
          attachBaseBadge(row, btnRow, attempt + 1);
        }, 80);
        return;
      }
      const badge = createBaseBadge(baseCheckbox);
      btnRow.appendChild(badge);
      row.dataset.monitoriaBadgeAdded = '1';
    };

    const getUploaderName = (row) => {
      const cell = row.querySelector('td.field-enviado_por');
      if (!cell) {
        return '';
      }
      const input = cell.querySelector('input[type="text"]');
      if (input && input.value.trim()) {
        return input.value.trim();
      }
      const select = cell.querySelector('select');
      if (select) {
        const selected = select.selectedOptions[0];
        if (selected && selected.textContent.trim()) {
          return selected.textContent.trim();
        }
      }
      const linkText = cell.querySelector('a');
      if (linkText && linkText.textContent.trim()) {
        return linkText.textContent.trim();
      }
      const raw = cell.textContent || '';
      return raw.trim();
    };

    const renderUploaderLine = (row, nomeCell) => {
      if (!row || !nomeCell) {
        return;
      }
      let uploaderLine = row.querySelector('.documento-peticoes-uploader-line');
      if (!uploaderLine) {
        uploaderLine = document.createElement('div');
        uploaderLine.className = 'documento-peticoes-uploader-line';
        nomeCell.appendChild(uploaderLine);
      }
      const name = getUploaderName(row);
      uploaderLine.textContent = name ? `Enviado por ${name}` : '';
      uploaderLine.style.display = name ? 'block' : 'none';
    };

    const setupModifyControl = (row, arquivoCell) => {
      if (!row || row.dataset.modifyControlAdded === '1' || !arquivoCell) {
        return;
      }
      const fileUpload = arquivoCell.querySelector('p.file-upload');
      if (!fileUpload) {
        return;
      }
      const fileInput = fileUpload.querySelector('input[type="file"]');
      const nomeCell = row.querySelector('td.field-nome');
      if (!nomeCell) {
        return;
      }
      Array.from(fileUpload.childNodes).forEach(node => {
        if (node.nodeType === Node.TEXT_NODE) {
          node.textContent = '';
        }
      });
      const modifyRow = document.createElement('div');
      modifyRow.className = 'documento-peticoes-modify-row';
      const label = document.createElement('span');
      label.textContent = 'Modificar:';
      label.style.fontWeight = '600';
      const button = document.createElement('button');
      button.type = 'button';
      button.className = 'button button-secondary';
      button.textContent = 'Procurar...';
      button.addEventListener('click', (event) => {
        event.preventDefault();
        if (fileInput) {
          fileInput.click();
        }
      });
      modifyRow.appendChild(label);
      modifyRow.appendChild(button);
      nomeCell.appendChild(modifyRow);
      renderUploaderLine(row, nomeCell);
      fileUpload.style.display = 'none';
      row.dataset.modifyControlAdded = '1';
    };

    const processRow = (row) => {
      if (row.dataset.downloadButtonsInjected === '1') {
        return;
      }
      const arquivoCell = row.querySelector('td.field-arquivo');
      const link = arquivoCell?.querySelector('a[href*="/media/"], a[href*="processos/"]');
      if (!link) {
        return;
      }
      link.style.display = 'none';

      const btnRow = document.createElement('div');
      btnRow.className = 'documento-peticoes-download-row';
      btnRow.style.display = 'flex';
      btnRow.style.flexWrap = 'wrap';
      btnRow.style.gap = '6px';
      btnRow.style.margin = '6px 0 4px 0';
      btnRow.style.alignItems = 'center';
      btnRow.style.justifyContent = 'flex-start';

      btnRow.appendChild(createButton('Visualizar', link.href));
      if (isMonitoriaRow(row)) {
        btnRow.appendChild(createButton('PDF', link.href, { download: true }));
        btnRow.appendChild(createButton('DOC', link.href, { download: true }));
        attachBaseBadge(row, btnRow);
      } else {
        btnRow.appendChild(createButton('Baixar', link.href, { download: true }));
      }

      const nomeCell = row.querySelector('td.field-nome');
      if (nomeCell) {
        nomeCell.appendChild(btnRow);
      } else {
        row.appendChild(btnRow);
      }

      setupModifyControl(row, arquivoCell);
      renderUploaderLine(row, nomeCell);

      row.dataset.downloadButtonsInjected = '1';
    };

    const tryInsert = () => {
      const rows = arquivosGroup.querySelectorAll('tr.dynamic-processoarquivo, tr.dynamic-arquivos');
      rows.forEach(processRow);
    };

    tryInsert();
    const observer = new MutationObserver(tryInsert);
    observer.observe(arquivosGroup, { childList: true, subtree: true });
  })();


  // Troca o checkbox de remover por botão com confirmação no inline de Arquivos
  (function enhanceArquivoInlineDeletes() {
    const inlineGroup = document.querySelector('#processoarquivo_set-group');
    if (!inlineGroup) return;
    // esconde coluna Remover? (admin default)
    const headers = inlineGroup.querySelectorAll('th.delete, th.column-delete, thead th:last-child');
    headers.forEach(h => { h.style.display = 'none'; });
    // esconde células de delete via CSS direto
    inlineGroup.querySelectorAll('td.delete, td.column-delete').forEach(td => td.style.display = 'none');
    // fallback: esconde última coluna do thead/tbody
    const headCells = inlineGroup.querySelectorAll('table thead tr th');
    const lastIdx = headCells.length ? headCells.length - 1 : -1;
    if (lastIdx >= 0) {
      headCells[lastIdx].style.display = 'none';
      inlineGroup.querySelectorAll('table tbody tr').forEach(tr => {
        const cells = tr.querySelectorAll('td, th');
        if (cells[lastIdx]) cells[lastIdx].style.display = 'none';
      });
    }

    // Cria contêiner de remoção abaixo do bloco de andamentos
    const deleteBlockParent = Array.from(document.querySelectorAll('.submit-row')).find(el => el.textContent.includes('Excluir Andamentos Selecionados')) || document.querySelector('#content-main') || document.body;
    let removeContainer = document.getElementById('arquivo-delete-actions');
    if (!removeContainer) {
      removeContainer = document.createElement('div');
      removeContainer.id = 'arquivo-delete-actions';
      removeContainer.style.marginTop = '10px';
      removeContainer.style.display = 'flex';
      removeContainer.style.flexDirection = 'column';
      removeContainer.style.gap = '6px';
      removeContainer.innerHTML = '<strong>Remover arquivos:</strong>';
      deleteBlockParent.appendChild(removeContainer);
    }

    const rows = inlineGroup.querySelectorAll('.dynamic-processoarquivo');
    rows.forEach(row => {
      const deleteCheckbox = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
      if (!deleteCheckbox) return;
      if (row.dataset.deleteBtnAdded) return;
      const td = deleteCheckbox.closest('td, th, label');
      if (td) td.style.display = 'none';
      deleteCheckbox.style.display = 'none';

      // pega nome do arquivo
      const nomeInput = row.querySelector('input[name$="-nome"]');
      const fileName = (nomeInput && nomeInput.value) ? nomeInput.value : 'Arquivo';

      const btn = document.createElement('button');
      btn.type = 'button';
      btn.textContent = `Remover "${fileName}"`;
      btn.className = 'button';
      btn.style.backgroundColor = '#ba2121';
      btn.style.color = '#fff';
      btn.style.alignSelf = 'flex-start';
      btn.addEventListener('click', () => {
        const ok = confirm(`Remover o arquivo "${fileName}"?`);
        if (!ok) return;
        deleteCheckbox.checked = true;
        row.style.opacity = '0.5';
        row.style.pointerEvents = 'none';
      });
      removeContainer.appendChild(btn);
      row.dataset.deleteBtnAdded = '1';
    });
    // última garantia: remove checkboxes remanescentes
    inlineGroup.querySelectorAll('input[type="checkbox"][name$="-DELETE"]').forEach(cb => {
      cb.style.display = 'none';
      const wrap = cb.closest('td, th, label');
      if (wrap) wrap.style.display = 'none';
    });
  })();

});
</script>
{% endblock %}
