{% extends "admin/contratos/processojudicial/change_list.html" %}
{% load static %}

{# Adiciona os estilos do mapa sem sobrescrever os originais #}
{% block extrastyle %}
    {{ block.super }}
    <style>
        #mapa-brasil svg {
            width: 100%;
            height: auto;
            stroke: #fff;
            stroke-width: 1;
        }
        #mapa-brasil svg path {
            fill: #ccc;
            cursor: pointer;
            transition: fill 0.2s ease-in-out, transform 0.2s ease-in-out;
        }
        #mapa-brasil svg path:hover {
            fill: #999;
            transform: none !important;
        }
        #mapa-brasil svg path.highlighted {
            fill: #417690;
            transform: none !important;
        }

        /* Estilos para estados sem processos */
        #mapa-brasil svg path.estado-vazio {
            cursor: not-allowed;
        }
        #mapa-brasil svg path.highlighted-vazio {
            fill: #ffcccc; /* Vermelho suave */
            transform: none !important;
        }
        /* Ajuste vertical do mapa */
        #mapa-brasil {
            margin-top: 30%;
        }
    </style>
{% endblock %}

{% block extrahead %}
    {{ block.super }}
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const filterRoot = document.getElementById('changelist-filter');
        if (!filterRoot) return;
        const detailsList = Array.from(filterRoot.querySelectorAll('details'));
        if (!detailsList.length) return;
        const normalize = (value) => (value || '')
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g, '')
          .trim()
          .toLowerCase();
        const targetDetails = detailsList.find(details => {
          const summary = details.querySelector('summary');
          return summary && normalize(summary.textContent) === 'por uf';
        });
        if (!targetDetails) return;

        const params = new URLSearchParams(window.location.search);
        const hasUf = params.getAll('uf').filter(Boolean).length > 0;
        if (!hasUf) {
          targetDetails.open = false;
        }

        const mapaUrl = "{% static 'admin/js/mapa_interativo.js' %}";
        let mapaLoaded = false;
        const loadMapa = () => {
          if (mapaLoaded) return;
          mapaLoaded = true;
          const script = document.createElement('script');
          script.src = mapaUrl;
          script.async = true;
          document.head.appendChild(script);
        };

        if (targetDetails.open) {
          loadMapa();
        }
        targetDetails.addEventListener('toggle', () => {
          if (targetDetails.open) {
            loadMapa();
          }
        });
      });
    </script>
{% endblock %}

{# Adiciona o contêiner do mapa sem sobrescrever o conteúdo original #}
{% block content %}
    {{ block.super }}
    <div id="mapa-brasil-wrapper" style="display: none;">
        {% include "admin/contratos/processojudicial/mapa_uf_interativo.html" %}
    </div>
{% endblock %}
