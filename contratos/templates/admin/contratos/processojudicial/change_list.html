{% extends "admin/change_list.html" %}

{% block extrastyle %}
    {{ block.super }}
    <style>
        #changelist-filter li.selected a {
            font-weight: bold;
            text-decoration: underline;
        }
        /* Container que mantém os blocos alinhados na mesma coluna */
        .custom-filters-container {
            width: 150px;
            box-sizing: border-box;
            position: fixed;
            top: 200px;
            right: 0;
            padding-right: 8px;
            font-size: 0.8rem;
        }
        #changelist-filter h2,
        #changelist-filter label,
        #changelist-filter a,
        #changelist-filter button,
        #changelist-filter select {
            font-size: 0.8rem;
        }
        #changelist-filter {
            width: 100%;
            box-sizing: border-box;
            margin: 0;
            float: none;
            clear: none;
        }
        /* Cabeçalho fixo e rolagem vertical na lista */
        body.change-list #changelist-form {
            transform: scale(0.7);
            transform-origin: top left;
            width: calc(100% / 0.7);
        }
        /* Rolagem com cabeçalho fixo */
        body.change-list #changelist-form .results {
            max-height: calc(100vh - 240px);
            overflow-y: auto;
            overflow-x: auto;
        }
        body.change-list #result_list thead th {
            position: sticky;
            top: 0;
            z-index: 2;
            background: #f5f5f5;
        }
        /* Filtros personalizados dentro da barra lateral */
        #changelist-filter .custom-filters-header {
            background: #3f708a;
            color: #fff;
            padding: 10px 12px;
            font-size: 14px;
            font-weight: 400;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            margin: 0;
        }
        #changelist-filter .custom-filters-toggle {
            color: #d9e6ef;
            font-weight: 400;
            }
        #changelist-filter .custom-filters-panel {
            display: none;
            padding: 10px 12px;
            background: #f4f7f9;
            border-bottom: 1px solid #d9d9d9;
            border-left: 1px solid #d9d9d9;
            border-right: 1px solid #d9d9d9;
        }
        body div#nav-sidebar {
            width: 96px;
            transform: scale(0.8);
            transform-origin: top left;
        }
        body div#nav-sidebar .module {
            padding-left: 6px;
            padding-right: 6px;
        }
        body div#nav-sidebar .module h2,
        body div#nav-sidebar .module a {
            font-size: 0.72rem;
            line-height: 1.1;
        }
        body div#nav-sidebar .module li a {
            font-size: 0.64rem;
            line-height: 1.1;
        }
        #changelist-filter .custom-filters-actions {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 6px;
        }
        #changelist-filter .custom-filters-actions button,
        #changelist-filter .custom-filters-actions select {
            font-size: 11px;
            padding: 3px 8px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            background: #fff;
        }
        #changelist-filter .custom-filters-saved {
            font-size: 11px;
            color: #417690;
            display: none;
        }
        #custom-clear-all {
            margin: 8px 0 6px 0;
            padding: 4px 8px;
            font-size: 12px;
            font-family: inherit;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            background: #f7f7f7;
            cursor: pointer;
            transform: translateY(-20%);
        }
        .cnj-nav-wrapper {
            font-size: 0.92rem;
            color: #1d2b3a;
            gap: 4px;
        }
        .cnj-nav-wrapper a,
        .cnj-nav-wrapper span {
            color: inherit;
        }
        .cnj-nav-control {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: transparent;
            border: none;
            color: inherit;
            cursor: pointer;
            font-weight: 400;
        }
        .cnj-nav-control.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .cnj-nav-current {
            font-size: 0.96rem;
            font-weight: 400;
        }
        .cnj-nav-count {
            font-size: 0.75rem;
            color: #5a6573;
        }
        #result_list tbody tr.clickable-row {
            cursor: pointer;
            transition: background-color 0.1s ease;
        }
        #result_list tbody tr.clickable-row:hover {
            background-color: rgba(0, 90, 160, 0.1);
        }
        #result_list,
        #result_list th,
        #result_list td {
            font-size: 1.1rem;
        }
    </style>
{% endblock %}

{% block content %}
    <script>
        // Move o script para o final do bloco de conteúdo para garantir que os elementos existam
        document.addEventListener('DOMContentLoaded', function() {
            const filterDiv = document.getElementById('changelist-filter');
            if (filterDiv) {
                const filterTitle = filterDiv.querySelector('h2');
                if (filterTitle) {
                    const toggleButton = document.createElement('span');
                    toggleButton.id = 'filter-toggle';
                    toggleButton.textContent = ' [–]';
                    filterTitle.appendChild(toggleButton);
                }
            }
        });
    </script>
{{ block.super }}

    <!-- Modal de delegação em massa -->
    <div id="delegate-modal" style="display:none; position: fixed; z-index: 2000; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.2); align-items: center; justify-content: center;">
        <div style="background:#fff; padding:16px; border-radius:6px; box-shadow:0 6px 18px rgba(0,0,0,0.2); min-width:280px; max-width:90%;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <h3 style="margin:0;">Delegar processos selecionados</h3>
                <button type="button" id="delegate-close" style="border:none; background:transparent; font-size:20px; cursor:pointer;">×</button>
            </div>
            <label for="delegate-user" style="display:block; margin-bottom:8px; font-weight:bold;">Escolha o usuário</label>
            <select id="delegate-user" style="width:100%; padding:6px; margin-bottom:12px;">
                <option value="">-- Remover delegação --</option>
                {% for user in delegar_users %}
                <option value="{{ user.id }}">{{ user.get_full_name|default:user.username }}</option>
                {% endfor %}
            </select>
            <div style="display:flex; gap:8px; justify-content:flex-end;">
                <button type="button" id="delegate-cancel" class="button">Cancelar</button>
                <button type="button" id="delegate-confirm" class="button default">Aplicar</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const STORAGE_KEY = 'processo_filtros_salvos';
        const filterDiv = document.getElementById('changelist-filter');
        if (!filterDiv) return;

        const header = document.createElement('div');
        header.className = 'custom-filters-header';
        const titleSpan = document.createElement('span');
        titleSpan.textContent = 'FILTROS PERSONALIZADOS';
        const toggleSpan = document.createElement('span');
        toggleSpan.className = 'custom-filters-toggle';
        toggleSpan.id = 'custom-filters-toggle';
        toggleSpan.textContent = '[+]';
        header.appendChild(titleSpan);
        header.appendChild(toggleSpan);

        const panel = document.createElement('div');
        panel.className = 'custom-filters-panel';
        panel.id = 'custom-filters-panel';

        const savedLabel = document.createElement('span');
        savedLabel.id = 'custom-filters-saved';
        savedLabel.className = 'custom-filters-saved';

        const actions = document.createElement('div');
        actions.className = 'custom-filters-actions';

        const saveBtn = document.createElement('button');
        saveBtn.type = 'button';
        saveBtn.id = 'custom-save';
        saveBtn.textContent = 'Salvar combinação atual';

        const select = document.createElement('select');
        select.id = 'custom-select';
        const opt0 = document.createElement('option');
        opt0.value = '';
        opt0.textContent = 'Selecione um filtro salvo...';
        select.appendChild(opt0);

        const applyBtn = document.createElement('button');
        applyBtn.type = 'button';
        applyBtn.id = 'custom-apply';
        applyBtn.textContent = 'Aplicar';

        const clearBtn = document.createElement('button');
        clearBtn.type = 'button';
        clearBtn.id = 'custom-clear';
        clearBtn.textContent = 'Limpar';

        actions.appendChild(saveBtn);
        actions.appendChild(select);
        actions.appendChild(applyBtn);
        actions.appendChild(clearBtn);

        panel.appendChild(actions);
        panel.appendChild(savedLabel);

        const wrapper = document.createElement('div');
        wrapper.className = 'custom-filters-wrapper';
        wrapper.appendChild(header);
        wrapper.appendChild(panel);

        // Insere o bloco personalizado no topo do filtro padrão
        filterDiv.insertBefore(wrapper, filterDiv.firstChild);

        function loadSaved() {
            try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
            catch(e){ return []; }
        }
        function saveSaved(list) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
        }
        function refreshSelect() {
            const list = loadSaved();
            select.innerHTML = '';
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = 'Selecione um filtro salvo...';
            select.appendChild(opt);
            list.forEach(item => {
                const o = document.createElement('option');
                o.value = item.qs;
                o.textContent = item.name;
                select.appendChild(o);
            });
        }
        refreshSelect();

        toggleSpan.addEventListener('click', () => {
            const isOpen = panel.style.display === 'block';
            panel.style.display = isOpen ? 'none' : 'block';
            toggleSpan.textContent = isOpen ? '[+]' : '[–]';
        });

        saveBtn.addEventListener('click', () => {
            const name = prompt('Nome do filtro:');
            if (!name) return;
            const qs = window.location.search || '';
            const list = loadSaved();
            const idx = list.findIndex(i => i.name === name);
            if (idx >= 0) list[idx] = { name, qs }; else list.push({ name, qs });
            saveSaved(list);
            refreshSelect();
            savedLabel.textContent = `Filtro salvo: ${name}`;
            savedLabel.style.display = 'inline';
        });

        applyBtn.addEventListener('click', () => {
            const qs = select.value;
            if (!qs) return;
            window.location.search = qs;
        });

        clearBtn.addEventListener('click', () => {
            const list = loadSaved().filter(i => i.qs !== select.value);
            saveSaved(list);
            refreshSelect();
            select.value = '';
            savedLabel.textContent = '';
            savedLabel.style.display = 'none';
            const url = new URL(window.location.href);
            url.search = '';
            url.searchParams.set('_skip_saved_filters', '1');
            window.location.href = url.pathname + url.search;
        });

        // Toggle para colapsar/expandir apenas os filtros padrão (mantém título e bloco personalizado)
        const filterToggle = document.getElementById('filter-toggle');
        if (filterDiv && filterToggle) {
            const collapsible = Array.from(filterDiv.children).filter(el => {
                return el.tagName !== 'H2' &&
                       !el.classList.contains('custom-filters-wrapper') &&
                       !el.classList.contains('custom-filters-header') &&
                       !el.classList.contains('custom-filters-panel');
            });
            let collapsed = false;
            const applyCollapse = () => {
                collapsible.forEach(el => { el.style.display = collapsed ? 'none' : ''; });
                filterToggle.textContent = collapsed ? ' [+]' : ' [–]';
            };
            applyCollapse();
            filterToggle.addEventListener('click', (ev) => {
                ev.preventDefault();
                collapsed = !collapsed;
                applyCollapse();
            });
        }

        // Toggle mostrar/ocultar contagem (usa spans .filter-count)
        const countToggle = Array.from(filterDiv.querySelectorAll('a, button, span')).find(el => {
            return /contagem/i.test((el.textContent || '').trim());
        });
        const countNodes = filterDiv.querySelectorAll('.filter-count');
        if (countToggle && countNodes.length) {
            countToggle.style.cursor = 'pointer';
            const countLinks = Array.from(filterDiv.querySelectorAll('li a'));
            countLinks.forEach(a => {
                if (!a.dataset.fullText) a.dataset.fullText = (a.textContent || '').trim();
            });
            const stripParens = (text) => text.replace(/\s*\([^)]*\)\s*$/, '').trim();

            let showCounts = true;
            const applyCount = () => {
                countNodes.forEach(n => { n.style.display = showCounts ? '' : 'none'; });
                countLinks.forEach(a => {
                    const full = a.dataset.fullText || a.textContent || '';
                    a.textContent = showCounts ? full : stripParens(full);
                });
                countToggle.textContent = showCounts ? 'Ocultar contagem' : 'Mostrar contagem';
            };
            applyCount();
            countToggle.addEventListener('click', (ev) => {
                ev.preventDefault();
                showCounts = !showCounts;
                applyCount();
            });
        }

        // Botão custom de limpar filtros (caso o link nativo não apareça)
        const clearAllBtn = document.createElement('button');
        clearAllBtn.type = 'button';
        clearAllBtn.id = 'custom-clear-all';
        clearAllBtn.textContent = 'Limpar filtros';
        clearAllBtn.addEventListener('click', () => {
            const url = new URL(window.location.href);
            url.search = '';
            window.location.href = url.pathname;
        });
        if (countToggle && countToggle.parentNode) {
            countToggle.parentNode.insertBefore(clearAllBtn, countToggle);
        } else {
            filterDiv.insertBefore(clearAllBtn, filterDiv.firstChild);
        }

        // Multi-seleção de UF: permite marcar/desmarcar múltiplas UFs sem perder as já escolhidas
        const ufLinks = Array.from(filterDiv.querySelectorAll('a[href*="uf="]'));
        ufLinks.forEach(link => {
            link.addEventListener('click', (ev) => {
                ev.preventDefault();
                const target = new URL(link.href, window.location.origin);
                const ufValue = target.searchParams.get('uf');
                if (!ufValue) return;

                const current = new URLSearchParams(window.location.search);
                const values = current.getAll('uf').filter(Boolean);
                const exists = values.includes(ufValue);
                const next = exists ? values.filter(v => v !== ufValue) : [...values, ufValue];
                current.delete('uf');
                next.forEach(v => current.append('uf', v));
                const newSearch = current.toString();
                window.location.search = newSearch ? `?${newSearch}` : '';
            }, { passive: false });
        });

        // Destaque visual nas UFs selecionadas (lista)
        const params = new URLSearchParams(window.location.search);
        const selectedUFs = new Set(params.getAll('uf').map(v => v.toUpperCase()).filter(Boolean));
        ufLinks.forEach(link => {
            const ufValue = new URL(link.href, window.location.origin).searchParams.get('uf');
            if (ufValue && selectedUFs.has(ufValue.toUpperCase())) {
                link.style.fontWeight = 'bold';
                link.style.textDecoration = 'underline';
            }
        });

        // Preserva filtros ao entrar no detalhe (adiciona _changelist_filters nos links da lista)
        const currentFilters = window.location.search.replace(/^\?/, '');
        if (currentFilters) {
            document.querySelectorAll('#result_list tbody tr th a').forEach(a => {
                const url = new URL(a.href, window.location.origin);
                url.searchParams.set('_changelist_filters', currentFilters);
                a.href = url.toString();
            });
        }
    });
    </script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('changelist-form');
        const actionSelect = form ? form.querySelector('select[name="action"]') : null;
        const delegateModal = document.getElementById('delegate-modal');
        const delegateUser = document.getElementById('delegate-user');
        const delegateConfirm = document.getElementById('delegate-confirm');
        const delegateCancel = document.getElementById('delegate-cancel');
        const delegateClose = document.getElementById('delegate-close');
        const delegateUrl = "{% url 'admin:processo_delegate_bulk' %}";

        if (!form || !actionSelect || !delegateModal) return;

        function getCsrfToken() {
            const match = document.cookie.match(/csrftoken=([^;]+)/);
            return match ? match[1] : '';
        }
        function getSelectedIds() {
            return Array.from(form.querySelectorAll('input.action-select:checked')).map(el => el.value);
        }
        function showModal() {
            delegateModal.style.display = 'flex';
        }
        function hideModal() {
            delegateModal.style.display = 'none';
        }
        function applyDelegation(ids, userId) {
            const body = new URLSearchParams();
            body.append('ids', ids.join(','));
            body.append('user_id', userId || '');
            fetch(delegateUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCsrfToken(),
                },
                body: body.toString(),
            }).then(() => {
                hideModal();
                window.location.reload();
            }).catch(() => {
                hideModal();
                window.location.reload();
            });
        }

        form.addEventListener('submit', function(e) {
            if (!actionSelect || actionSelect.value !== 'delegate_processes') return;
            e.preventDefault();
            const ids = getSelectedIds();
            if (!ids.length) {
                alert('Selecione ao menos um processo para delegar.');
                return;
            }
            showModal();
        });

        [delegateCancel, delegateClose].forEach(btn => {
            if (btn) btn.addEventListener('click', hideModal);
        });

        if (delegateConfirm) {
            delegateConfirm.addEventListener('click', function() {
                const ids = getSelectedIds();
                if (!ids.length) {
                    hideModal();
                    return;
                }
                applyDelegation(ids, delegateUser ? delegateUser.value : '');
            });
        }
    });
    </script>
{% endblock %}

{% block extrahead %}
    {{ block.super }}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const etiquetasData = JSON.parse('{{ etiquetas_data_json|escapejs }}' || '{}');
        
        setTimeout(function() {
            const table = document.getElementById('result_list');
            if (!table) return;

            const rows = Array.from(table.querySelectorAll('tbody tr'));
            rows.forEach(row => {
                const input = row.querySelector('input.action-select');
                if (!input) return;

                const processoId = input.value;
                const etiquetas = etiquetasData[processoId];

                if (etiquetas && etiquetas.length > 0) {
                    // 1. Garante que a linha seja um container de posicionamento
                    row.style.position = 'relative';
                    
                    // 2. Aumenta o padding inferior de TODAS as células na linha para criar espaço
                    const cells = row.getElementsByTagName('td');
                    for (let cell of cells) {
                        cell.style.paddingBottom = '35px';
                    }
                    const thCell = row.getElementsByTagName('th')[0];
                    if (thCell) {
                        thCell.style.paddingBottom = '35px';
                    }

                    // 3. Cria o container para as etiquetas
                    const container = document.createElement('div');
                    container.style.position = 'absolute';
                    container.style.bottom = '5px';
                    container.style.left = '10px';
                    container.style.right = '10px';
                    container.style.whiteSpace = 'nowrap';
                    container.style.overflow = 'hidden';
                    // container.style.borderTop = '1px solid rgba(0, 0, 0, 0.1)'; // Linha removida
                    container.style.paddingTop = '5px';
                    container.style.textAlign = 'left'; // Garante o alinhamento à esquerda


                    etiquetas.forEach(e => {
                        const badge = document.createElement('span');
                        badge.className = 'etiqueta-badge';
                        badge.textContent = e.nome;
                        badge.style.backgroundColor = e.cor_fundo;
                        badge.style.color = e.cor_fonte;
                        badge.style.paddingRight = '10px';
                        badge.style.transform = 'scale(0.75)';
                        badge.style.transformOrigin = 'left';
                        badge.style.marginRight = '-2px';
                        container.appendChild(badge);
                    });
                    
                    // 4. Anexa o container à primeira célula (ele se posicionará em relação à linha inteira)
                    row.cells[0].appendChild(container);
                }
            });
        }, 250);
    });
    </script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const table = document.getElementById('result_list');
        if (!table) return;
        const rows = Array.from(table.querySelectorAll('tbody tr'));
        rows.forEach(row => {
            const changeLink = row.querySelector('th a[href*="/change/"]');
            if (!changeLink) return;
            row.classList.add('clickable-row');
            row.addEventListener('click', function(event) {
                if (event.target.closest('a, button, input, select, textarea, label')) {
                    return;
                }
                changeLink.click();
            });
            row.addEventListener('keydown', function(event) {
                if (event.key !== 'Enter' && event.key !== ' ') {
                    return;
                }
                if (event.target.closest('a, button, input, select, textarea, label')) {
                    return;
                }
                event.preventDefault();
                changeLink.click();
            });
        });
    });
    </script>
{% endblock %}
