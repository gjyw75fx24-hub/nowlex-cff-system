{% extends "admin/change_list.html" %}

{% block extrastyle %}
    {{ block.super }}
    <style>
        #changelist-filter li.selected a {
            font-weight: bold;
            text-decoration: underline;
        }
        /* Container que mantém os blocos alinhados na mesma coluna */
        .custom-filters-container {
            width: 270px;
            box-sizing: border-box;
            float: right;
            clear: right;
        }
        #changelist-filter {
            width: 100%;
            box-sizing: border-box;
            margin: 0;
            float: none;
            clear: none;
        }
        /* Filtros personalizados dentro da barra lateral */
        #changelist-filter .custom-filters-header {
            background: #3f708a;
            color: #fff;
            padding: 10px 12px;
            font-size: 14px;
            font-weight: 400;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            margin: 0;
        }
        #changelist-filter .custom-filters-toggle {
            color: #d9e6ef;
            font-weight: 400;
            }
        #changelist-filter .custom-filters-panel {
            display: none;
            padding: 10px 12px;
            background: #f4f7f9;
            border-bottom: 1px solid #d9d9d9;
            border-left: 1px solid #d9d9d9;
            border-right: 1px solid #d9d9d9;
        }
        #changelist-filter .custom-filters-actions {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 6px;
        }
        #changelist-filter .custom-filters-actions button,
        #changelist-filter .custom-filters-actions select {
            font-size: 11px;
            padding: 3px 8px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            background: #fff;
        }
        #changelist-filter .custom-filters-saved {
            font-size: 11px;
            color: #417690;
            display: none;
        }
    </style>
{% endblock %}

{% block content %}
    <script>
        // Move o script para o final do bloco de conteúdo para garantir que os elementos existam
        document.addEventListener('DOMContentLoaded', function() {
            const filterDiv = document.getElementById('changelist-filter');
            if (filterDiv) {
                const filterTitle = filterDiv.querySelector('h2');
                if (filterTitle) {
                    const toggleButton = document.createElement('span');
                    toggleButton.id = 'filter-toggle';
                    toggleButton.textContent = ' [–]';
                    filterTitle.appendChild(toggleButton);
                }
            }
        });
    </script>
    {{ block.super }}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const STORAGE_KEY = 'processo_filtros_salvos';
        const filterDiv = document.getElementById('changelist-filter');
        if (!filterDiv) return;

        const header = document.createElement('div');
        header.className = 'custom-filters-header';
        const titleSpan = document.createElement('span');
        titleSpan.textContent = 'FILTROS PERSONALIZADOS';
        const toggleSpan = document.createElement('span');
        toggleSpan.className = 'custom-filters-toggle';
        toggleSpan.id = 'custom-filters-toggle';
        toggleSpan.textContent = '[+]';
        header.appendChild(titleSpan);
        header.appendChild(toggleSpan);

        const panel = document.createElement('div');
        panel.className = 'custom-filters-panel';
        panel.id = 'custom-filters-panel';

        const savedLabel = document.createElement('span');
        savedLabel.id = 'custom-filters-saved';
        savedLabel.className = 'custom-filters-saved';

        const actions = document.createElement('div');
        actions.className = 'custom-filters-actions';

        const saveBtn = document.createElement('button');
        saveBtn.type = 'button';
        saveBtn.id = 'custom-save';
        saveBtn.textContent = 'Salvar combinação atual';

        const select = document.createElement('select');
        select.id = 'custom-select';
        const opt0 = document.createElement('option');
        opt0.value = '';
        opt0.textContent = 'Selecione um filtro salvo...';
        select.appendChild(opt0);

        const applyBtn = document.createElement('button');
        applyBtn.type = 'button';
        applyBtn.id = 'custom-apply';
        applyBtn.textContent = 'Aplicar';

        const clearBtn = document.createElement('button');
        clearBtn.type = 'button';
        clearBtn.id = 'custom-clear';
        clearBtn.textContent = 'Limpar';

        actions.appendChild(saveBtn);
        actions.appendChild(select);
        actions.appendChild(applyBtn);
        actions.appendChild(clearBtn);

        panel.appendChild(actions);
        panel.appendChild(savedLabel);

        const wrapper = document.createElement('div');
        wrapper.className = 'custom-filters-wrapper';
        wrapper.appendChild(header);
        wrapper.appendChild(panel);

        // Insere o bloco personalizado no topo do filtro padrão
        filterDiv.insertBefore(wrapper, filterDiv.firstChild);

        function loadSaved() {
            try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
            catch(e){ return []; }
        }
        function saveSaved(list) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
        }
        function refreshSelect() {
            const list = loadSaved();
            select.innerHTML = '';
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = 'Selecione um filtro salvo...';
            select.appendChild(opt);
            list.forEach(item => {
                const o = document.createElement('option');
                o.value = item.qs;
                o.textContent = item.name;
                select.appendChild(o);
            });
        }
        refreshSelect();

        toggleSpan.addEventListener('click', () => {
            const isOpen = panel.style.display === 'block';
            panel.style.display = isOpen ? 'none' : 'block';
            toggleSpan.textContent = isOpen ? '[+]' : '[–]';
        });

        saveBtn.addEventListener('click', () => {
            const name = prompt('Nome do filtro:');
            if (!name) return;
            const qs = window.location.search || '';
            const list = loadSaved();
            const idx = list.findIndex(i => i.name === name);
            if (idx >= 0) list[idx] = { name, qs }; else list.push({ name, qs });
            saveSaved(list);
            refreshSelect();
            savedLabel.textContent = `Filtro salvo: ${name}`;
            savedLabel.style.display = 'inline';
        });

        applyBtn.addEventListener('click', () => {
            const qs = select.value;
            if (!qs) return;
            window.location.search = qs;
        });

        clearBtn.addEventListener('click', () => {
            const list = loadSaved().filter(i => i.qs !== select.value);
            saveSaved(list);
            refreshSelect();
            select.value = '';
            savedLabel.textContent = '';
            savedLabel.style.display = 'none';
        });

        // Toggle para colapsar/expandir apenas os filtros padrão (mantém título e bloco personalizado)
        const filterToggle = document.getElementById('filter-toggle');
        if (filterDiv && filterToggle) {
            const collapsible = Array.from(filterDiv.children).filter(el => {
                return el.tagName !== 'H2' &&
                       !el.classList.contains('custom-filters-wrapper') &&
                       !el.classList.contains('custom-filters-header') &&
                       !el.classList.contains('custom-filters-panel');
            });
            let collapsed = false;
            const applyCollapse = () => {
                collapsible.forEach(el => { el.style.display = collapsed ? 'none' : ''; });
                filterToggle.textContent = collapsed ? ' [+]' : ' [–]';
            };
            applyCollapse();
            filterToggle.addEventListener('click', (ev) => {
                ev.preventDefault();
                collapsed = !collapsed;
                applyCollapse();
            });
        }

        // Toggle mostrar/ocultar contagem (números das etiquetas/listas)
        const countToggle = Array.from(filterDiv.querySelectorAll('a, button, span')).find(el => {
            return /contagem/i.test((el.textContent || '').trim());
        });
        const countElems = filterDiv.querySelectorAll('.filter-count, .count, .counter');
        if (countToggle && countElems) {
            countToggle.style.cursor = 'pointer';
            let showCounts = true;
            const applyCount = () => {
                countElems.forEach(el => { el.style.display = showCounts ? '' : 'none'; });
                countToggle.textContent = showCounts ? 'Ocultar contagem' : 'Mostrar contagem';
            };
            applyCount();
            countToggle.addEventListener('click', (ev) => {
                ev.preventDefault();
                showCounts = !showCounts;
                applyCount();
            });
        }
    });
    </script>
{% endblock %}

{% block extrahead %}
    {{ block.super }}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const etiquetasData = JSON.parse('{{ etiquetas_data_json|escapejs }}' || '{}');
        
        setTimeout(function() {
            const table = document.getElementById('result_list');
            if (!table) return;

            const rows = Array.from(table.querySelectorAll('tbody tr'));
            rows.forEach(row => {
                const input = row.querySelector('input.action-select');
                if (!input) return;

                const processoId = input.value;
                const etiquetas = etiquetasData[processoId];

                if (etiquetas && etiquetas.length > 0) {
                    // 1. Garante que a linha seja um container de posicionamento
                    row.style.position = 'relative';
                    
                    // 2. Aumenta o padding inferior de TODAS as células na linha para criar espaço
                    const cells = row.getElementsByTagName('td');
                    for (let cell of cells) {
                        cell.style.paddingBottom = '35px';
                    }
                    const thCell = row.getElementsByTagName('th')[0];
                    if (thCell) {
                        thCell.style.paddingBottom = '35px';
                    }

                    // 3. Cria o container para as etiquetas
                    const container = document.createElement('div');
                    container.style.position = 'absolute';
                    container.style.bottom = '5px';
                    container.style.left = '10px';
                    container.style.right = '10px';
                    container.style.whiteSpace = 'nowrap';
                    container.style.overflow = 'hidden';
                    // container.style.borderTop = '1px solid rgba(0, 0, 0, 0.1)'; // Linha removida
                    container.style.paddingTop = '5px';
                    container.style.textAlign = 'left'; // Garante o alinhamento à esquerda


                    etiquetas.forEach(e => {
                        const badge = document.createElement('span');
                        badge.className = 'etiqueta-badge';
                        badge.textContent = e.nome;
                        badge.style.backgroundColor = e.cor_fundo;
                        badge.style.color = e.cor_fonte;
                        badge.style.paddingRight = '10px';
                        badge.style.transform = 'scale(0.75)';
                        badge.style.transformOrigin = 'left';
                        badge.style.marginRight = '-2px';
                        container.appendChild(badge);
                    });
                    
                    // 4. Anexa o container à primeira célula (ele se posicionará em relação à linha inteira)
                    row.cells[0].appendChild(container);
                }
            });
        }, 250);
    });
    </script>
{% endblock %}
